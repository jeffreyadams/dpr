\documentclass{article}
\usepackage {amsmath, amsfonts, amssymb, mathrsfs, amsthm, sectsty,hyphenat,enumitem,calc,url,color,array,tabu}
%\usepackage{showlabels}
\usepackage{palatino}
\usepackage[all]{xy}
\usepackage[nottoc]{tocbibind}
\usepackage[toc,page]{appendix}
\usepackage{tocloft}

\renewcommand\cftsecafterpnum{\vskip2pt}
\renewcommand\cftsubsecafterpnum{\vskip2pt}


\newcommand{\redwarn}[1]{\textcolor{red}{#1}\message{#1}}


\setlength{\parindent}{0pt} \setlength{\parskip}{10pt plus 2pt minus 1pt}
\topmargin=-0.5in \headheight=0in \headsep=0.25in \textheight=9.1in
\footskip=0.75in

%\input{"Users/kaletha/Work/TexMain/macros.tex"}
%\input{"C:/Users/Tasho/Documents/Dropbox/Work/TexMain/macros.tex"}
\input{macros.tex}


\newtheorem{thm}{Theorem}[subsection]
\newtheorem{lem}[thm]{Lemma}
\newtheorem{pro}[thm]{Proposition}
\newtheorem{cor}[thm]{Corollary}
\newtheorem{fct}[thm]{Fact}
\newtheorem{clm}[thm]{Claim}
\newtheorem{asm}[thm]{Assumption}
\newtheorem{cnj}[thm]{Conjecture}
\newtheorem{exn}[thm]{Expectation}
\newtheorem{ntt}[thm]{Notation}
\theoremstyle{definition}
\newtheorem{dfn}[thm]{Definition}
\newtheorem{rem}[thm]{Remark}
\newtheorem{exa}[thm]{Example}
\newtheorem{cns}[thm]{Construction}

\sectionfont{\center\sc\normalsize}
\subsectionfont{\bf\normalsize}

\numberwithin{equation}{section}
\renewcommand{\-}{\hyp{}}
\hyphenation{co-cycle co-chain co-ho-mo-lo-gy}

\renewcommand{\appendixtocname}{Appendix}
\renewcommand{\appendixpagename}{\normalsize \center Appendix}

\newcommand{\warn}[1]{{\leavevmode\color{red}[#1]}}
%definitions by jda
\newcommand{\n}{\mathfrak n}
\newcommand{\s}{\mathfrak s}
\newcommand{\g}{\mathfrak g}
\newcommand{\p}{\mathfrak p}
\renewcommand{\k}{\mathfrak k}
\renewcommand{\O}{\mathcal O}
\newcommand{\K}{\mathcal K}
\newcommand{\Op}{\O_p}
\newcommand{\Oss}{\O_{ss}}
\newcommand{\wx}{\mathfrak w_X}
\newcommand{\w}{\mathfrak w}
\newcommand{\Cent}{\mathrm{Cent}}
\newcommand{\WF}{\mathrm{WF}}
\newcommand{\AS}{\mathrm{AS}}
\newcommand{\KS}{\mathrm{KS}}
\newcommand{\Cone}{\mathrm{Cone}}
\newcommand{\AC}{\mathrm{AC}}
\newcommand{\SL}{\mathrm{SL}}
\newcommand{\ch}[1]{\negthinspace\negthinspace\negthinspace\phantom{a}^\vee\negthinspace #1}

\begin{document}

\begin{mytitle} Discrete series $L$-packets for real reductive groups \end{mytitle}
\begin{center} Jeffrey Adams and Tasho Kaletha \end{center}

\begin{abstract}
We give a modern exposition of the construction, parameterization, and character relations, for discrete series $L$-packets of real reductive groups, which are fundamental results due to Langlands and Shelstad. This exposition incorporates the canonical double covers of tori and endoscopic groups, and gives a simple proof of Shahidi's generic packet conjecture, and incorporates normalized geometric transfer factors.
\end{abstract}

\tableofcontents

\section{Introduction}

\warn{TODO. Below a short list of topics to cover}

Fundamental results of Langlands Shelstad, cornerstone of many applications of the Langlands program to arithmetic questions. Exposition different from classical, more closely aligned to the treatment of $p$-adic groups in \cite{KalRSP}. Endoscopic transfer originally due to Shelstad \cite{She82}, with implicit transfer factors and implicit internal structure. Later Shelstad gave an updated treatment using the explicit factors of \cite{LS87}. However, the normalization of these factors had not yet been established, and this made the internal structure again implicit, and the spectral transfer was complicated due to the occurrence of the so called ``spectral transfer factors'', whose purpose was to incorporate the arbitrary choice of geometric transfer factor \cite{SheTE2}. The canonical internal structure was obtain in \cite{SheTE3} but only for quasi-split $K$-groups. For example, in the setting of unitary groups, there are two distinct $K$-groups. For unitary groups in odd variables, both $K$-groups contain the same inner forms, hence both are quasi-split, but for ever unitary groups, the two $K$-groups contain distinct inner forms, and only one is quasi-split. In the particular case of 4 variables, the one $K$-group is comprised of the compact groups $U(0,4)$ and $U(2,2)$, the latter of which is quasi-split, while the other contains only the non-quasi-split $U(3,1)$.

Here we give a direct and largely self-contained exposition of the construction of $L$-packets, their canonical internal structure, and proof of character identities. We work with the canonical normalization of transfer factors from the start. In full generality this requires the rigid inner twists of \cite{KalRI}, but to help the reader we work in parallel with Vogan's notion of pure inner twist. We also incorporate double covers of tori and endoscopic groups. This eliminates the need for auxiliary choices in the construction of packets and in the proof of character identities.

\section{Recollections}

\subsection{The $L$-group}

We review the $L$-group of a connected reductive group following \cite[\S2]{Vog93}.

Let $F$ be a field. Assume first that $F$ is separably closed. Let $G$ be a connected reductive $F$-group. Given a Borel pair $(T,B)$ of $G$ one has the based root datum $\tx{brd}(T,B,G)=(X^*(T),\Delta,X_*(T),\Delta^\vee)$, where $\Delta \subset X^*(T)$ is the set of $B$-simple roots for the adjoint action of $T$ on $\tx{Lie}(G)$, and $\Delta^\vee \subset X_*(T)$ are the corresponding coroots. For a second Borel pair $(T',B')$, there is a unique element of $T'(F)\lmod G(F)/T(F)$ that conjugates $(T,B)$ to $(T',B')$. This element provides an isomorphism $\tx{brd}(T,B,G) \to \tx{brd}(T',B',G)$. This procedure leads to a system of based root data and isomorphisms, indexed by the set of Borel pairs of $G$. The limit of that system is the based root datum $\tx{brd}(G)$ of $G$.

One can formalize the notion of a based root datum: we refer the reader to \cite[\S7.4]{Spr98} for the formal notion of a root datum, to which one has to add a set of simple roots to obtain the formal notion of a based root datum. Based root data can be placed into a category, in which all morphisms are isomorphisms, for the evident notion of isomorphism of based root data. The classification of connected reductive $F$-groups \cite[Theorem 9.6.2, Theorem 10.1.1]{Spr98} can be stated as saying that $G \mapsto \tx{brd}(G)$ is a full essentially surjective functor from the category of connected reductive $F$-groups and isomorphisms to the category of based root data and isomorphisms. Moreover, two morphisms lie in the same fiber of this functor if and only if they differ by an inner automorphism.

Consider now a general field $F$, let $F^s$ a separable closure, $\Gamma=\tx{Gal}(F^s/F)$ the Galois group. Given a connected reductive $F$-group $G$, there is a natural action of $\Gamma$ on the set of Borel pairs of $G_{F^s}$, and this leads to a natural action of $\Gamma$ on $\tx{brd}(G_{F^s})$. We denote by $\tx{brd}(G)$ the based root datum $\tx{brd}(G_{F^s})$ equipped with this $\Gamma$-action. Given two connected reductive $F$-groups $G_1,G_2$, an isomorphism $\xi : G_{1,F^s} \to G_{2,F^s}$ is called an \emph{inner twist}, if $\xi^{-1}\circ\sigma\circ\xi\circ\sigma^{-1}$ is an inner automorphism of $G_{1,F^s}$ for all $\sigma \in \Gamma$. The two groups $G_1,G_2$ are then called inner forms of each other. The functor $G \mapsto \tx{brd}(G)$ from the category of connected reductive $F$-groups to the category of based root data over $F$ and isomorphisms is again essentially surjective. It maps inner twists to isomorphisms, and two inner twists map to the same isomorphism if they differ by an inner automorphism. The fiber over a given based root datum over $F$ consists of all reductive groups that are inner forms of each other.

Given a based root datum $(X,\Delta,Y,\Delta^\vee)$ over $F$, its dual $(Y,\Delta^\vee,X,\Delta)$ is also a based rood datum over $F$. If $G$ is a connected reductive $F$-group with based root datum $(X,\Delta,Y,\Delta^\vee)$, its dual $\hat G$ is the unique split connected reductive group defined over a chosen base field (we will work with $\C$) with based root datum $(Y,\Delta^\vee,X,\Delta)$. Thus, given a Borel pair $(\hat T,\hat B)$ of $\hat G$ and a Borel pair $(T,B)$ of $G_{F^s}$, one is given an identification $X_*(\hat T)=X^*(T)$ that identifies the Weyl chambers associated to $\hat B$ and $B$.

To form the $L$-group, one chooses a pinning $(\hat T,\hat B,\{Y_\alpha\})$ of $\hat G$. The group of automorphisms of $\hat G$ that preserve this pinning is in natural isomorphism with the group of automorphisms of $\tx{brd}(\hat G)$, hence with that of $\tx{brd}(G)$. The $\Gamma$-action on $\tx{brd}(G)$ then lifts to an action on $\hat G$ by algebraic automorphisms, and $^LG=\hat G \rtimes \Gamma$.

When $G$ is quasi-split, $(T,B)$ is an $F$-Borel pair, and $(\hat T,\hat B)$ is a $\Gamma$-stable Borel pair of $\hat G$, then the identification $X_*(T)=X^*(\hat T)$ is $\Gamma$-equivariant.

\subsection{Inner forms}

Let $G$ be a connected reductive $F$-group. An \emph{inner twist} of $G$ is a pair $(G_1,\xi)$ where $G_1$ is a connected reductive $F$-group and $\xi : G_{F^s} \to G_{1,F^s}$ is an isomorphism, such that for each $\sigma \in \Gamma$ the automorphism $\xi^{-1}\sigma(\xi) = \xi^{-1}\circ\sigma\circ\xi\circ\sigma^{-1}$ of $G_{F^s}$ is inner. An isomorphism of inner twists $(G_1,\xi_1) \to (G_2,\xi_2)$ is a homomorphism $f : G_1 \to G_2$ of $F$-groups such that $\xi_2^{-1}\circ f \circ \xi_1$ is an inner automorphism of $G_{F^s}$. From an inner twist $(G_1,\xi)$ we obtain the function $\Gamma \to G/Z(G)$ given by $\sigma \mapsto \xi^{-1}\sigma(x)$. It is an element of $Z^1(F,G/Z(G))$, whose cohomology class depends only on the isomorphism class of $(G_1,\xi)$. In this way the set of isomorphism classes of inner twists is in bijection with $H^1(F,G/Z(G))$.



Following Vogan \cite{Vog93}, a \emph{pure inner twist} of $G$ is a triple $(G_1,\xi,z)$, where $G_1$ is a connected reductive $F$-group, $\xi : G_{F^s} \to G_{1,F^s}$ is an isomorphism and $z \in Z^1(\Gamma,G)$, subject to $\xi^{-1}\sigma(\xi)=\tx{Ad}(\bar z_\sigma)$, where $\bar z \in Z^1(F,G/Z(G))$ is the image of $z$ under the natural projection $G \to G/Z(G)$. An isomorphism of pure inner twists $(G_1,\xi_1,z_1) \to (G_2,\xi_2,z_2)$ is a pair $(f,g)$ consisting of an isomorphism $f : G_1 \to G_2$ of $F$-groups and $g \in G_0(F^s)$ such that $\xi_2^{-1}\circ f \circ \xi_1=\tx{Ad}(g)$ and $z_2(\sigma)=gz_1(\sigma)\sigma(g)^{-1}$ for all $\sigma \in \Gamma$. The map $(G_1,\xi,z) \mapsto z$ induces a bijection from the set of isomorphism classes of pure inner twists to $H^1(F,G)$.

There is a lighter notation in which inner twists and pure inner twists can be recorded. It is grounded on the fact that, if $(G_1,\xi)$ is an inner twist of $G$, with $\bar z \in Z^1(F,G/Z(G))$ given by $\bar z(\sigma)=\xi^{-1}\sigma(\xi)$, and we let $G_{\bar z}$ be the algebraic $F$-group obtained from $G$ by twisting the $F$-structure by $\bar z$, then $\xi$ becomes an isomorphism of $F$-groups $G_{\bar z} \to G_1$, in fact an isomorphism of inner twists $(G_{\bar z},\tx{id}) \to (G_1,\xi)$. Therefore the map $\bar z \mapsto (G_{\bar z},\tx{id})$ induces an injection from $Z^1(F,G/Z(G))$ into the class of all inner twists of $G$ which meets every isomorphism class. Two elements of $Z^1(F,G/Z(G))$ map into the same isomorphism class if and only if they lie in the same orbit for the action of $G(F^s)$ on $Z^1(F,G/Z(G))$ given by $(g \cdot z)(\sigma) = gz(\sigma)\sigma(g)^{-1}$. The orbits space for this action is $H^1(F,G/Z(G))$, and this gives the same identification between that orbit space and the set of isomorphism classes of inner twists as above.

The same simplification applies to the notion of pure inner twist. There we work with the set $Z^1(F,G)$ and obtain the embedding $z \mapsto (G_z,\tx{id},z)$ from that set into the class of pure inner twists of $G$. Again the orbit space for the action of $G(F^s)$ on $Z^1(F,G)$ by $(g\cdot z)(\sigma)=gz(\sigma)\sigma(g)^{-1}$ equals $H^1(F,G)$ and is identified with the set of isomorphism classes of pure inner twists.

We now take $F=\R$, hence $F^s=\C$. Then $\Gamma=\{1,c\}$, where $c$ is complex conjugation. An element of $Z^1(F,G)$ can be identified with the image of $c$, which is an element of $G(\C)$. We can also think of this as an element of the coset $G(\C) \rtimes c \subset G(\C) \rtimes \Gamma$. The elements of $Z^1(F,G)$ correspond precisely to the elements of $G(\C) \rtimes c$ of order $2$.

In \cite{ABV92} the notion of strong real form was introduced. This is an element $\delta \in G(\C) \rtimes c$, such that $\delta^2$ is a finite order element of $Z(G)(\C)$. In \cite{KalRI} this notion was given a cohomological interpretation and was extended to non-archimedean local fields. Following the latter reference, a \emph{rigid inner twist} of $G$ is a triple $(G_1,\xi,z)$, where $G_1$ is a connected reductive $\R$-group, $\xi : G_\C \to G_{1,\C}$ is an isomorphism and $z \in Z^1_\tx{bas}(\mc{E}_R,G)$, subject to $\xi^{-1}\sigma(\xi)=\tx{Ad}(\bar z_\sigma)$. Here $1 \to u_{\R}(\C) \to \mc{E}_R \to \Gamma \to 1$ is a certain extension of the Galois group, $Z^1_\tx{bas}(\mc{E}_\R,G)$ denotes the group of continuous 1-cocycles $\mc{E}_\R \to G(\C)$ whose restriction to $u_\R(\C)$ takes values in $Z(G)(\C)$, and $\bar z$ is again the image of $z$ under the natural projection map $G \to G/Z(G)$; it factors through the quotient $\mc{E}_\R \to \Gamma$. An isomorphism of pure inner twists $(G_1,\xi_1,z_1) \to (G_2,\xi_2,z_2)$ is a pair $(f,g)$ consisting of an isomorphism $f : G_1 \to G_2$ of $\R$-groups and $g \in G_0(\C)$ such that $\xi_2^{-1}\circ f \circ \xi_1=\tx{Ad}(g)$ and $z_2(e)=gz_1(e)\sigma_e(g)^{-1}$ for all $e \in \mc{E}_\R$, where $\sigma_e \in \Gamma$ is the image of $e$. The set of isomorphism classes of rigid inner twists is in bijection with $H^1_\tx{bas}(\mc{E}_\R,G)$. The equivalence between the cohomology classes in $H^1_\tx{bas}(\mc{E}_\R,G)$ and the elements $G(\C) \rtimes c$ whose square is a finite order element of $Z(G)(\C)$ is less obvious than in the Galois case, and is discussed in \cite[\S5.2]{KalRI}.

Each of these three notions partitions the set of isomorphism classes of connected reductive $\R$-groups into equivalence classes. The notion of inner twist is the most classical, stemming from the classification of reductive groups, and each equivalence class has exactly one quasi-split member. Unfortunately, this notion is not rigid enough for representation theory -- the group of automorphisms of an inner twist $(G_1,\xi)$ is $(G_1/Z(G_1))(\R)$, and the conjugation by such an element can be an outer automorphism of the Lie group $G_1(\R)$.

The notion of pure inner twist is sufficiently rigid -- the group of automorphisms of a pure inner twist $(G_1,\xi,z)$ is $G_1(\R)$, hence acts by inner automorphisms of $G_1(\R)$. Unfortunately, the equivalence classes induced by this notion are generally smaller, and not all of them contain a quasi-split member.

The notion of a rigid inner twist is again sufficiently rigid, and in addition the equivalence classes in induces coincide with those induced by the notion of inner twist. This will be the notion that we will use.

For further discussion of this topic we refer the reader to \cite{Vog93} and \cite{KalSimons}.

Given an inner twist $\xi : G \to G_1$, the isomorphism $\xi$ induces an isomorphism $\tx{brd}(G) \to \tx{brd}(G_1)$, which is $\Gamma$-equivariant, even though $\xi$ itself is not. This leads to an identification of dual groups $\hat G = \hat G_1$ and $L$-groups $^LG = {^LG}_1$.


\subsection{Admissible embeddings of tori} \label{sub:adm}

Let $F$ be a field and let $G$ be a connected reductive $F$-group. Let $\hat G$ be its dual group, defined over any base field, which we take to be $\C$, equipped with a $\Gamma$-action.

Let $S$ be an $F$-torus. We recall from \cite[\S5.1]{KalRSP} that, given a $\Gamma$-stable $\hat G$-conjugacy class $\hat J$ of embeddings $\hat S \to \hat G$ whose images are maximal tori, there is an associated $\Gamma$-stable $G(F^s)$-conjugacy class $J$ of embeddings $S \to G$. To obtain $J$, we first assume that $G$ is quasi-splut. Fix $\Gamma$-stable Borel pairs $(\hat T,\hat B)$ and $(T,B)$ in $\hat G$ and $G$, respectively. Thus we have the identifications $X_*(T)=X^*(\hat T)$ and $\Omega(T,G)=\Omega(\hat T,\hat G)$ as $\Gamma$-modules. There is $\hat\jmath \in \hat J$ with image $\hat T$ and we obtain the isomorphism $X_*(T)=X^*(\hat T) \to X^*(\hat S)=X_*(S)$, hence an isomorphism $j : S_{F^s} \to T_{F^s}$. We let $J$ be the $G(F^s)$-conjugacy class of the composition of $j$ with the inclusion $T \to G$.

For $\sigma \in \Gamma$ the embedding $\sigma(\hat\jmath\,)=\sigma_{\hat G}\circ \hat\jmath \circ \sigma_{\hat S}$ is $\hat G$-conjugate to $\hat\jmath$, but has the same image because $\hat T$ is $\Gamma$-stable, so there exists $w \in \Omega(\hat T,\hat G)$ such that $\sigma(\hat\jmath)=w\circ\hat\jmath$. By construction of $j$ we have $\sigma(j)=w\circ j$, using $\Omega(T,G)=\Omega(\hat T,\hat G)$, and conclude that $J$ is $\Gamma$-stable. Since all $\Gamma$-stable Borel pairs of $\hat G$ are conjugate under $\hat G^\Gamma$, and all $\Gamma$-stable Borel pairs of $G$ are conjugate under $G(F)$, the construction of $J$ does not depend on the choices of Borel pairs.

Now drop the assumption that $G$ is quasi-split. We consider an inner twist $\xi : G_0 \to G$ with $G_0$ quasi-split. It gives an identification $\hat G_0=\hat G$ and we obtain from $\hat J$ a $\Gamma$-stable $G_0(F^s)$-conjugacy class $J_0$ of embeddings $S \to G_0$. Composing with $\xi$ we obtain the desired $G(F^s)$-conjugacy class $J$ of embeddings $S \to G$. It is $\Gamma$-stable, because the $G(F^s)$-conjugacy class of $\xi$ is.

This completes the construction of $J$. We will refer to it as the set of \emph{admissible} embeddings $S \to G$. If we want to record the group $G$ we will write $J^G$.

Write $J(F)$ for the set of $\Gamma$-fixed points in $J$, i.e. the set of embeddings $S \to G$ defined over $F$. When $G=G_0$ is quasi-split, a result of Kottwitz \cite[Corollary 2.2]{Kot82} guarantees that this set is non-empty. For a general $G$ this set may be empty. The group $G(F)$ acts on $J(F)$ by conjugation and we will write $J(F)/G(F)$ for the set of orbits under this action.

Given any two elements $j_1,j_2 \in J(F)$ there exists $g \in G(F^s)$ such that $j_2 = \tx{Ad}(g)\circ j_1$. The map $\sigma \mapsto j_1^{-1}(g^{-1}\sigma(g))$ is a 1-cocycle of $\Gamma$ valued in $S(F^s)$. Its class is independent of $g$ and will be denoted by $\tx{inv}(j_1,j_2)$. For a fixed $j \in J(F)$ the map $j_2 \mapsto \tx{inv}(j_1,j_2)$ is a bijection between $J(F)/G(F)$ and $\tx{ker}(H^1(j_1) : H^1(F,S) \to H^1(F,G))$.

One can combine multiple inner forms in this discussion to obtain a more uniform picture. This requires the use of pure or rigid inner twists. Fix a quasi-split group $G_0$. We start with the case of pure inner twists and consider tuples $(G,\xi,z,j)$, where $(G,\xi,z)$ is a pure inner twist of $G_0$ and $j \in J^G(F)$. An isomorphism $(G_1,\xi_1,z_1,j_1) \to (G_2,\xi_2,z_2,j_2)$ between such tuples is an isomorphism $(f,g) : (G_1,\xi_1,z_1) \to (G_2,\xi_2,z_2)$ of inner twists that satisfies $j_2=f\circ j_1$. Let $\mc{J}(F)$ be the category whose objects are these tuples and whose morphisms are these isomorphisms. Given two tuples as above there exists $g \in G_0(F^s)$ such that $j_2 = \xi_2 \circ \tx{Ad}(g)\circ\xi_1^{-1}\circ j_1$. The map $\sigma \mapsto j_1^{-1}(g^{-1}z_2(\sigma)\sigma(g)z_1(\sigma)^{-1})$ \warn{which side should $z_1$ be on?} is a 1-cocycle $\Gamma \to S(F^s)$ whose class $\tx{inv}(j_2,j_1)$ depends only on the isomorphism classes of the tuples. Fixing the tuple $(G_1,\xi_1,z_1,j_1)$, the map $(G_2,\xi_2,z_2,j_2) \mapsto \tx{inv}(j_1,j_2)$ induces a bijection from the set of isomorphism classes $[\mc{J}(F)]$ to $H^1(F,S)$.


The individual groups can be extracted from the combined picture as follows. For a fixed $(G,\xi,z)$ we can view the set $J^G(F)$ as the set of objects in a category, with set of morphisms $j_1 \to j_2$ given by $\{g \in G(F)|j_2=\tx{Ad}(g)\circ j_1\}$. Then we obtain an embedding (fully faithful functor) from $J^G(F)$ to $\mc{J}(F)$. The category $\mc{J}(F)$ decomposes into blocks, indexed by $H^1(F,G_0)$, and each block is equivalent to $J^G(F)$ for some $(G,\xi,z)$. In particular, the set of isomorphism classes $[\mc{J}(F)]$ is the disjoint union $\bigcup_{H^1(F,G_0)} (J^G(F)/G(F))$. If we choose $j_0 \in J^{G_0}(F)$, then under the bijection $[\mc{J}(F)] \to H^1(F,S)$ given by $(G,\xi,z,j) \mapsto \tx{inv}(j,j_0)$, an individual $J^G(F)/G(F)$ coming from $(G,\xi,z)$ is mapped bijectively onto the fiber of $H^1(j_0) : H^1(F,S) \to H^1(F,G)$ over the class of $z$.

The bijection $[\mc{J}(F)] \to H^1(F,S)$ coming from fixing $(G,\xi,z,j)$ can be understood as the orbit map for a natural action of $H^1(F,S)$ on $[\mc{J}(F)]$ that does not depend on any choices. To see this action it is easier to consider the simplified notation, where a pure inner twist of $G_0$ is understood simply as an element $z \in Z^1(F,G_0)$, in the sense that it corresponds to $(G_z,\tx{id},z)$, where $G_z$ is the $F$-group obtained by twisting the rational structure of $G_0$ by $z$. Then $\mc{J}$ consists of pairs $(z,j)$, where $z \in Z^1(F,G_0)$ and $j \in J^{G_0}$. Such a pair lies in $\mc{J}(F)$ if and only if $j \in J^{G_z}(F)$, which is explicitly given as $\tx{Ad}(z(\sigma))\sigma_{G_0} \circ j \circ \sigma_S^{-1}=j$. The group $G_0(F^s)$ acts on $\mc{J}$ by $g \cdot (z,j) = (gz(\sigma)\sigma(g)^{-1},\tx{Ad}(g)\circ j)$. This action preserves $\mc{J}(F)$ and the orbit space is $[\mc{J}(F)]$. We introduce the action of $Z^1(F,S)$ on $\mc{J}(F)$ as $x \cdot (z,j) = (j(x) \cdot z,j)$ for $x \in Z^1(F,S)$ and $(z,j) \in \mc{J}(F)$. One checks directly that the actions of $Z^1(F,S)$ and $G(F^s)$ on $\mc{J}(F)$ commute and that the action of $S(F^s)$ on $Z^1(F,S)$ is compatible with the action of $Z^1(F,S)$ on $\mc{J}(F)$ in the sense that $(s\cdot x) \cdot (z,j) = j(s) \cdot (x \cdot (z,j))$. Thus we obtain an action of $H^1(F,S)$ on $[\mc{J}(F)]$. 
\begin{lem} \label{lem:simtrans}
The above action is simply transitive.
\end{lem}
\begin{proof}
For simplicity, let $x \in Z^1(F,S)$, $g \in G_0(F^s)$, and $(z,j) \in \mc{J}(F)$ be such that $g \cdot (z,j)=x\cdot (z,j)$. Then $j=\tx{Ad}(g)\circ j$ from which we see that $g=j(s)$ for some $s \in S(F^s)$. We also have $j(s)z(\sigma)\sigma_{G_0}(j(s))^{-1}=j(x(\sigma))\cdot z(\sigma)$ and multiplying on the right by $z(\sigma)^{-1}$ and using that $(z,j) \in \mc{J}(F)$ we conclude $j(s \cdot \sigma_S(s)^{-1})=j(x(\sigma))$, thus $[x]=1$ in $H^1(F,S)$, as desired.

For transitivity, we need to show that any two elements of $[\mc{J}(F)]$ are in the same $H^1(F,S)$ orbit. Since the members of $J^{G_0}$ are all conjugate under $G_0(F^s)$ we may represent the two elements of $[\mc{J}(F)]$ by $(z_1,j)$ and $(z_2,j)$ with the same $j$. The fact that both lie in $\mc{J}(F)$ implies that $\tx{Ad}(z_1(\sigma))\circ\sigma_{G_0}\circ j = \tx{Ad}(z_2(\sigma))\circ\sigma_{G_0}\circ j$. It follows that $\sigma_{G_0}^{-1}(z_2(\sigma)^{-1}z_1(\sigma))$ lies in the image of $j$, and we write it as $j(\sigma_S^{-1}(x(\sigma)))$ for some $x(\sigma) \in S(F^s)$. Using that $(z_1,j),(z_2,j) \in \mc{J}(F)$ we see that $j(x(\sigma))=z_1(\sigma)z_2(\sigma)^{-1}$. From this one easily checks that $x \in Z^1(F,S)$ and concludes $(z_1,j)=x\cdot (z_2,j)$, as desired.
\end{proof}

The procedure that produced $J$ from $\hat J$ is invertible. Given a $\Gamma$-stable $G(F^s)$-conjugacy class $J$ of embeddings $S \to G$, we compose with $\xi^{-1}$ to obtain a $\Gamma$-stable $G_0(F^s)$-conjugacy class $J_0$ of embeddings $S \to G_0$. Pick a $\Gamma$-stable Borel pairs $(T,B)$ of $G_0$ and $(\hat T,\hat B)$ of $\hat G$. Choose $j \in J_0$ giving an isomorphism $S \to T$ and use it to get identifications $X^*(\hat S)=X_*(S)=X_*(T)=X^*(\hat T)$. The resulting isomorphism $\hat S \to \hat T$ is not $\Gamma$-equivariant, but translates the $\Gamma$-structure on $\hat S$ to a twist by $\Omega(\hat T,\hat G)$ of the $\Gamma$-structure on $\hat T$. Therefore the composition of this isomorphism with the tautological inclusion $\hat T \to \hat G$ has the property that its $\hat G$-conjugacy class $\hat J$ is $\Gamma$-stable. 


The same discussion applies to the setting of rigid inner forms when the base field is local. One should only replace $H^1(F,-)$ with $H^1(u_F \to \mc{E}_F,Z(G) \to -)$.

\subsection{Representations and elements in inner forms} \label{sub:across}

In \S\ref{sub:adm} we reviewed the idea of grouping the various admissible embeddings of a torus $S$ into the different inner forms of a fixed group $G_0$, thereby obtaining a set $\mc{J}(F)$ with an action of $G_0(F^s)$ on it. Here we follow the same idea, but group elements or representations. 

We focus on $F=\R$, although the same procedure applies for any $F$ of interest. Let $\tilde\Pi$ be the set of pairs $(z,\pi)$, where $z \in Z^1(F,G_0)$ and $\pi$ is an isomorphism class of irreducible admissible representations of $G_z(F)$, where $G_z$ is again the $\R$-group obtained by twisting the $\R$-structure of $G_0$ by $z$. The group $G_0(\C)$ acts on this set by $g\cdot (z,\pi) = (gz(\sigma)\sigma(g)^{-1},\pi \circ\tx{Ad}(g)^{-1})$. Note that $\tx{Ad}(g) : G_z \to G_{gz(\sigma)\sigma(g)^{-1}}$ is an isomorphism of algebraic $\R$-groups. Let $\Pi=\tilde\Pi/G_0(\C)$. This is the set of isomorphism classes of irreducible admissible representations of pure inner forms of $G_0$. The pairs $(z,\pi) \in \tilde\Pi$ with a fixed $z$ correspond to all isomorphism classes of representations of $G_z(\R)$.

Similarly, consider the set of pairs $(z,\delta)$, where $z \in Z^1(F,G_0)$ and $\delta \in G_z(F)$ is a regular semi-simple element. The group $G_0(\C)$ acts on this set by $g\cdot (z,\delta)=(gz(\sigma)\sigma(g)^{-1},g\delta g^{-1})$. If two pairs $(z_1,\delta_1)$ and $(z_2,\delta_2)$ are in the same orbit for this action, we will call them \emph{stably conjugate}. Just as with the case of admissible embeddings, there is a cohomological invariant $\tx{inv}((z_1,\delta_1),(z_2,\delta_2)) \in H^1(F,S_1)$, where $S_1 \subset G_0$ is the centralizer of $\delta_1$, a maximal $\R$-torus of $G_{z_1}$. This invariant is the class of the 1-cocycle $z_2 \cdot z_1^{-1}$ \warn{check again that this is the correct order}. If $z_1=z_2$, then the element of $G_0(\C)$ that conjugates them must lie in $G_z(\R)$, and we see that $\delta_1$ and $\delta_2$ are $G_z(\R)$ conjugate; we will call them \emph{rationally} conjugate. With this in mind, we call the orbit space for this action the set of rational classes of regular semi-simple elements of pure inner forms. 

\subsection{Weyl denominators} \label{sub:weyldenom}

Let $G$ be a connected reductive $\R$-group and $T \subset G$ a maximal $\R$-torus. One can consider the function $T(\R) \to \R$ defined as
\[ D_G(t) = \textstyle\prod\limits_{\alpha \in R(T,G)} (1-\alpha(t)). \]
In this paper we will normalize orbital integrals and characters by multiplying them by $|D_G(t)|^{1/2}$. Thus, for $t \in T(\R)$ strongly regular and $f \in \mc{C}_c^\infty(G(\R))$ we set
\[ J(t,f) = |D_G(t)|\int_{G(\R)/T(\R)} f(gtg^{-1})dg, \]
while for $\pi$ admissible representation of $G(\R)$ we have
\[ J(t,\pi) = |D_G(t)|\Theta_\pi(t), \]
where $\Theta_\pi$ is the character function of $\pi$. This has the advantage that the resulting functions remain bounded as $t$ approaches singular elements in $T(\R)$.

A key role in this paper will be played by a function $D_B$ which has the property that $|D_B|=|D_G|^{1/2}$. To see this function, let us interpret $D_G$ as an element of the group ring $\Z[Q]$, where $Q \subset X^*(T)\otimes\Q$ is the root lattice, we we write the group operation on $Q$ multiplicatively. Given a Borel $\C$-subgroup $B \subset G$ containing $T$ we write $\alpha>0$ when $\alpha$ is a $B$-positive root, and define
\begin{equation} \label{eq:weyldenom}
D_B' = \prod_{\alpha>0} (1-\alpha^{-1}) \in \Q[Q],\qquad D_B = \prod_{\alpha>0} (\alpha^{1/2}-\alpha^{-1/2}) \in \Q[Q].
\end{equation}
In $\Q[Q]$ we have the identity
\begin{equation} \label{eq:dgb}
D_B = \rho \cdot D_B',	
\end{equation}
where $\rho=\prod_{\alpha>0} \alpha^{1/2} \in Q$. This implies
\[ D_G = D_B' \cdot D_{\bar B}' = D_B \cdot D_{\bar B}, \]
where $\bar B$ is the Borel subgroup opposite to $B$. Moreover, for $w \in \Omega(T,G)$ we have
\begin{equation} \label{eq:wsd}
wD_B = D_{w^{-1}Bw} = \tx{sgn}(w)D_B.	
\end{equation}
In particular, $|D_B|$ is independent of the choice of $B$ and hence $|D_G|^{1/2}=|D_B|$, provided we can interpret $D_B$ as a function on $T(\R)$.

It is clear that $D_B'$ is a function on $T(\R)$. If we want to interpret $D_B$ as a function of $T(\R)$, the occurrence of $\alpha^{1/2}$ in the formula causes a problem. From \eqref{eq:dgb} we see that $D_B$ will be a function of $T(\R)$ if and only if $\rho$ is, which is equivalent to the element $\rho$ lying in $X^*(T)$. This is always the case when $G$ is semi-simple and simply connected, but can fail in general. To remedy this situation, one can introduce a double cover of $T(\R)$, which will be discussed in the next section.

\subsection{Double covers of tori and $L$-embeddings} \label{sub:covtori}

Let $G$ be a connected reductive $\R$-group and let $T \subset G$ be a maximal torus. An obstruction to the element $D_B$ defining a function on $T(\R)$ is the fact that $\rho \in \frac{1}{2}X^*(T)$ may not lie in $X^*(T)$. To remedy this, Adams--Vogan introduce in \cite{AV92}, \cite{AV16} the $\rho$-double cover $T(\R)_\rho$ as the pull-back of the diagram
\[ T(\R)\stackrel{\rho^2}{\lrw} \C^\times \stackrel{(-)^2}{\llw} \C^\times, \]
which comes equipped with a natural character $\rho : T(\R)_\rho \to \C^\times$, namely the projection onto the right factor $\C^\times$. By construction we have an exact sequence
\[ 1 \to \{\pm 1\} \to T(\R)_\rho \to T(\R) \to 1 \]
and $\rho$ is a genuine character, i.e. $\rho(-x)=-\rho(x)$ for $x \in T(\R)_\rho$, where $-x$ denote the product of $x$ and the element $-1$.

While the double cover $T(\R)_\rho$ appears to depend on $\rho$, this is actually not so. Indeed, for any other Borel $\C$-subgroup $B'$ we have $\rho'/\rho \in X^*(T)$, which allows us to define the genuine character $\rho' : T(\R)_\rho \to \C^\times$ as $\rho \cdot (\rho'/\rho)$. Combining this character with the natural projection $T(\R)_\rho \to T(\R)$ gives a map from $T(\R)_\rho$ to the diagram defining $T(\R)_{\rho'}$, hence an isomorphism $T(\R)_\rho \to T(\R)_{\rho'}$.

To emphasize the independence of $T(\R)_\rho$ on $\rho$, and emphasize the dependence on the ambient group $G$, we will write $T(\R)_G$ for this cover. For each Borel $\C$-subgroup $B$ we have the genuine character $\rho_B : T(\R)_G \to \C^\times$.

In this paper we will be particularly interested in the case when $T$ is elliptic. Then there is a different way to obtain the $\rho$-cover that generalizes to all local fields, as discussed in \cite{KalDC}. One first defines the ``big cover'' of $T(\R)$ as follows. Each root provides a homomorphism $\alpha : T(\R) \to \mb{S}^1$. Combining these homomorphisms for a pair $A=\{\alpha,-\alpha\}$ provides a homomorphism $A : T(\R) \to \mb{S}^1_-$, where $\mb{S}^1_- \subset \mb{S}^1 \times \mb{S}^1$ is the kernel of the product map $\mb{S}^1 \times \mb{S}^1 \to \mb{S}^1$. Define the ``big cover'' as the pull-back of
\begin{equation} \label{eq:bigcover}
T(\R) \stackrel{(\alpha)}{\lrw} \prod \mb{S}^1_- \stackrel{z/\bar z}{\llw} \prod(\C^\times/\R_{>0})_-
\end{equation}
where the products run over the set of pairs $A=\{\alpha,-\alpha\}$ consisting of a root and its negative, and $(\C^\times/\R_{>0})_-$ denotes analogously the anti-diagonal in $(\C^\times/\R_{>0}) \times (\C^\times/\R_{>0})$. The result is an extension
\[ 1 \to \prod\{\pm1\} \to T(\R)_{GG} \to T(\R) \to 1. \]
Under the isomorphism $\mb{S}^1 \to \C^\times/\R_{>0}$ the map $z/\bar z$ becomes the squaring map, and we see that $T(\R)_{GG}$ is equipped with a character $\alpha^{1/2} : T(\R)_{GG} \to \mb{S}^1$ for each root $\alpha$, and that $\beta^{1/2}=(\alpha^{1/2})^{-1}$ whenever $\beta=\alpha^{-1}$. There is an obvious surjective homomorphism $T(\R)_{GG} \to T(\R)_G$ whose kernel is the kernel of the multiplication map $\prod\{\pm1\} \to \{\pm1\}$. The function $\alpha^{1/2}-\alpha^{-1/2}$ is well-defined on the big cover, while for any choice Borel $\C$-subgroup $V$ the function
\[ D_B := \prod_{\alpha>0}(\alpha^{1/2}-\alpha^{-1/2}) \]
descends to the double cover $T(\R)_G$.

The action of the Weyl group $\Omega_G(T)(\R)$ lifts naturally to an action on $T(\R)_G$, even on $T(\R)_{GG}$, because $\Omega_G(T)(\R)$ acts naturally on each term in \eqref{eq:bigcover}. The identity \eqref{eq:wsd} holds for this function.

What makes the double cover $T(\R)_G$ very useful in the setting of the Langlands program is the fact that there is an associated $L$-group $^LT_G$, as well as a \emph{canonical} $\hat G$-conjugacy class of $L$-embeddings $^LT_G \to {^LG}$, cf. \cite[\S4.1]{KalDC}. The property of the $L$-group $^LT_G$ is that the set of $\hat T$-conjugacy classes of $L$-homomorphisms $W_\R \to {^LT}_G$ is in natural bijection with the set of genuine characters of $T(\R)_G$. Therefore, any $L$-parameter for $G$ that factors through the image of the embedding of $^LT_G$ provides in a canonical way an $\Omega_G(T)(\R)$-orbit of genuine characters of $T(\R)_G$.

In contrast to $^LT_G$, there is generally no canonical $L$-embedding $^LT \to {^LG}$. In fact, if the Galois form of $^LT$ is used, there is generally no $L$-embedding $^LT \to {^LG}$ at all, let alone a canonical one. If the Weil form of $^LT$ is used, then there always do exist $L$-embeddings $^LT \to {^LG}$, but there is generally no canonical choice. If one chooses a genuine character of $T(\R)_G$, then the pointwise product of its $L$-parameter $W_\R \to {^LT_G}$ with the natural inclusion $\hat T \to {^LT_G}$ does lead to an $L$-isomorphism $^LT \to {^LT_G}$ between the Weil forms of the $L$-groups for $T(\R)$ and $T(\R)_G$. Composing this isomorphism with the canonical $L$-embedding $^LT_G \to {^LG}$ provides an $L$-embedding $^LT \to {^LG}$, and every $L$-embedding arises from this construction. A convenient choice for a genuine character on $T(\R)_G$ is the character $\rho$ associated to some Borel $\C$-subgroup of $G$ containing $T$.

It is worth pointing out that all $L$-embeddings $^LT \to {^LG}$, as well as all $L$-embeddings $^LT_G \to {^LG}$, that extend a fixed embedding $\hat\jmath : \hat T \to \hat G$, have the same image, namely
\begin{equation} \label{eq:lembim}
\{x \in N_{^LG}(\hat T)\,|\, x\cdot\hat\jmath(t)\cdot x^{-1} = \hat\jmath(\sigma_x(t))\ \forall t \in \hat T\},
\end{equation}
where $\sigma_x \in \Gamma$ is the image of $x$ under the natural projection $^LG \to \Gamma$.


\subsection{Essentially square-integrable representations} \label{sub:essds}

Let $G$ be a connected reductive $\R$-group. An essentially square integrable representation of $G(\R)$ is one which, after possibly tensoring with a continuous character $G(\R) \to \C^\times$, has a unitary central character, and such that every matrix coefficient is square-integrable on $G(\R)/Z_G(\R)$ (since the central character is unitary, the absolute value of a matrix coefficient is trivial on $Z_G(\R)$).

Harish-Chandra has shown that the set of isomorphism classes of essentially square-integrable representations is in bijection with the set of $G(\R)$-conjugacy classes of pairs $(S,\tau)$, where $S \subset G$ is an elliptic maximal torus, and $\tau$ is a genuine character of the double cover $S(\R)_G$ whose differential is regular. This bijection is characterized by the fact that the character function of the representation corresponding to $(S,\tau)$, evaluated at a regular element $\delta \in S(\R)$, is given by
\begin{equation} \label{eq:charfmla}
(-1)^{q(G)}\sum_{w \in N(S,G)(\R)/S(\R)} \frac{\tau}{d_\tau}(w\delta) = (-1)^{q(G)}\sum_{w \in N(S,G)(\R)/S(\R)} \frac{\tau'}{d'_\tau}(w\dot\delta).
\end{equation}
We explain the notation. Pull back $\tau$ to a character of $S_\tx{sc}(\R)_G$, where $S_\tx{sc}$ is the preimage of $S$ in the universal cover $G_\tx{sc}$ of the derived subgroup of $G$. The cover $S_\tx{sc}(\R)_G$ splits canonically, because $\rho$ is divisible by $2$ in $X^*(S_\tx{sc})$. Therefore $\tau$ provides a character $\tau_\tx{sc}$ of $S_\tx{sc}(\R)$. This being a compact torus, $\tau_\tx{sc}$ is an algebraic character, i.e. an element of $X^*(S_\tx{sc})$, and coincides with its differential, which is still regular. Thus $\tau$ specifies a choice of positive roots, i.e. a Borel $\C$-subgroup $B$ containing $S$. Write $D_\tau$ in place of $D_B$ for the Weyl denominator \eqref{eq:weyldenom}. Since our convention (cf. \S\ref{sub:weyldenom}) is to normalize orbital integrals and characters by the absolute value of this denominator, we will only need $d_\tau=\tx{arg}D_\tau$. Both $\tau$ and $d_\tau$ are genuine functions of $S(\R)_G$, so their quotient $\Theta:=\tau/d_\tau$ descends to $S(\R)$.

In the second sum we have set $\tau'=\tau \cdot \rho_B^{-1}$, and $d_\tau'=d_\tau \cdot \rho_B^{-1}$, cf. \eqref{eq:dgb}. In this way, both numerator and denominator are functions of $S(\R)$. Note that $\rho_B$ takes values in $\mb{S}^1$ because $S$ is elliptic.

\subsection{Endoscopic groups and double covers} \label{sub:covendo}

The notion of endoscopic data is introduced in \cite[\S1.2]{LS87}, and is a variation of the notion of endoscopic pairs or endoscopic triples discussed in \cite{Kot84} and \cite{Kot86}.

It can be described equivalently as follows. An endoscopic datum for $G$ is a tuple $(H,s,\mc{H},\eta)$ consisting of
\begin{enumerate}[label=(\arabic*)]
	\item a quasi-split connected reductive group $H$,
	\item an extension $1 \to \hat H \to \mc{H} \to \Gamma \to 1$ of topological groups,
	\item a semi-simple element $s \in Z(\hat H)$, and
	\item an $L$-embedding $\mc{H} \to {^LG}$.
\end{enumerate}
It is required that
\begin{enumerate}[label=(\alph*)]
	\item the extension $\mc{H}$ admits a splitting by a continuous group homomorphism $\Gamma \to \mc{H}$,
	\item the homomorphism $\Gamma \to \tx{Out}(\hat H)$ provided by $\mc{H}$ coincides with the one provided by the extension $^LH$,
	\item $\eta$ identifies $\hat H$ with the identity component of the centralizer of $\eta(s)$ in $\hat G$,
	\item there exists $z \in Z(\hat G)$ such that $s\eta^{-1}(z) \in Z(\hat H)^\Gamma$.
\end{enumerate}
The map $\eta$ produces a $\Gamma$-equivariant embedding $Z(\hat G) \to Z(\hat H)$, that we will use without explicit notation.

An isomorphism $(H_1,s_1,\mc{H}_1,\eta_1) \to (H_2,s_2,\mc{H}_2,\eta_2)$ is an element $g \in \hat G$ that satisfies the following properties. First, $\tx{Ad}(g)\eta_1(\mc{H}_1)=\eta_2(\mc{H}_2)$. In particular, $\eta_2^{-1}\circ\tx{Ad}(g)\circ\eta_1$ is an $L$-isomorphism $\mc{H}_1 \to \mc{H}_2$, and restricts to a $\Gamma$-equivariant isomorphism $Z(\hat H_1) \to Z(\hat H_2)$. The second condition is that the resulting isomorphism $\pi_0(Z(\hat H_1)/Z(\hat G)) \to \pi_0(Z(\hat H_2)/Z(\hat G))$ maps the coset of $s_1$ to the coset of $s_2$.

In this paper we are working with pure (resp. rigid) inner twists, and this necessitates a slight refinement of the notion of endoscopic datum. A \emph{pure refined} endoscopic datum is one in which it is required $s \in Z(\hat H)^\Gamma$ in point (3), and this eliminates the need for condition (d). An isomorphism of such data is required to map the coset of $s_1$ to the coset of $s_2$ under $\pi_0(Z(\hat H_1)^\Gamma) \to \pi_0(Z(\hat H_2)^\Gamma)$, without dividing by $Z(\hat G)$. A \emph{rigid refined} endoscopic datum replaces $s \in Z(\hat H)^\Gamma$ by $\dot s \in Z(\hat{\bar H})^+$. An isomorphism of such data is required to map the coset of $\dot s_1$ to the coset of $\dot s_2$ under $\pi_0(Z(\hat{\bar H_1})^+) \to \pi_0(Z(\hat{ \bar H_2})^+)$.

Given an $L$-parameter $\varphi : W_\R \to {^LG}$ and a semi-simple element $s \in S_\varphi$, where $S_\varphi=\tx{Cent}(\varphi,\hat G)$, one obtains a pure refined endoscopic datum as follows. Set $\hat H = \tx{Cent}(s,\hat G)^\circ$. The homomorphism  $\varphi : W_\R \to \tx{Cent}(s,\hat G) \to \tx{Out}(\hat H)$ factors through the projection $W_\R \to \Gamma$. There is a unique (up to isomorphism) quasi-split connected reductive $\R$-group $H$ with dual group $\hat H$ such that the homomorphism $\Gamma \to \tx{Out}(H)=\tx{Out}(\hat H)$ induced by the $\R$-structure of $H$ matches the one induced by $\varphi$. Set $\mc{H}=\hat H \cdot \varphi(W_\R)$, and let $\eta$ be the tautological inclusion $\mc{H} \to {^LG}$. In the rigid setting, the same construction works starting with $\dot s \in S_\varphi^+$, where $S_\varphi^+$ is the preimage in $\hat{\bar G}$ of $S_\varphi$.

By construction the parameter $\varphi$ takes values in $\mc{H}$. However, the extensions $\mc{H}$ and $^LH$ of $\Gamma$ by $\hat H$ need not be isomorphic, and even if they are, there is no natural isomorphism between them. Therefore, $\varphi$ is \emph{not} a parameter for $H$ in any natural way. There are two ways to remedy this situation.

The classical approach is to choose a $z$-extension $H_1 \to H$ and an $L$-embedding $\mc{H} \to {^LH_1}$ that extends the natural embedding $\hat H \to \hat H_1$. These choices (which always exist, cf. \cite[\S2.2]{KS99}) are called a $z$-pair. They provide a parameter $\varphi_1$ for $H_1$.

An approach introduced in \cite{KalHDC} is to extend the theory of double covers of tori from \cite{KalDC} to the setting of quasi-split connected reductive groups. The datum $\mc{H}$ then leads to a \emph{canonical} double cover $H(F)_\pm$ of $H(F)$ and a \emph{canonical} isomorphism $^LH_\pm \to \mc{H}$. In this way, $\varphi$ naturally becomes a parameter for $H(F)_\pm$, and there are no choices involved.

\subsection{Transfer of orbital integrals} \label{sub:transfer}

We continue with an endoscopic datum $(H,s,\mc{H},\eta)$ for $G$. In the pure setting we demand $s \in Z(\hat H)^\Gamma$, and in the rigid setting we demand $s \in Z(\hat{\bar H})^+$. We will review here the transfer of orbital integrals, which is dual to the transfer of characters that is the subject of this paper.

As explained in \S\ref{sub:covendo}, in the classical setting order to formulate endoscopic transfer (both geometric and spectral), one has to make an arbitrary choice of a $z$-pair $(H_1,\eta_1)$, where $H_1 \to H$ is a surjective homomorphism of algebraic groups whose kernel is an induced torus, and $\eta_1 : \mc{H} \to {^LH_1}$ is an $L$-embedding. 

Alternatively, \cite{KalHDC} shows that there is a canonical double cover $H(F)_\pm \to H(F)$ and a canonical isomorphism $L^H_\pm \to \mc{H}$, whose composition with $\eta$ then becomes an $L$-embedding $^LH_\pm \to {^LG}$. In this framework, no auxiliary choices are needed.

The transfer of orbital integrals and characters between $G$ and $H$ is governed by the transfer factor. In the classical case, it is a function
\[ \Delta : H_1(\R)^\tx{rs} \times G(\R)^\tx{rs} \to \C \]
that depends on the $z$-pair datum, while in the setting of covers it is a function
\[ \Delta : H(R)_\pm^\tx{rs} \times G(\R)^\tx{rs} \to \C \]
that is genuine in the first argument. In the classical case, it is given as the product
\[ \epsilon \cdot \Delta_I^{-1}\Delta_{II}\Delta_{III_1}^{-1}\Delta_{III_2}. \]
The individual factors are defined in \cite{LS87}, except for $\epsilon$, which is defined in the more general twisted setting in \cite[\S5.3]{KS99}, and $\Delta_{III_1}$, whose relative definition is given in \cite{LS87}, but whose absolute definition is given in \cite{KalECI} in the setting of pure inner forms, and in \cite{KalRI} in the setting of rigid inner forms. The inverses appear due to the conventions of \cite[(1.0.4)]{KS12}, which we will use in this paper. The term $\Delta_{IV}$ is missing because we have normalized orbital integrals and characters by the Weyl denominator. We will not review the construction of the individual pieces here, as it has been reviewed in various other places, such as \cite[\S3.5,\S4.2,\S4.3]{KalIMS}. The individual factors depend on auxiliary data, known as $a$-data and $\chi$-data. The total factor depends on a choice of Whittaker datum, and $z$-datum.

In the case of covers, the transfer factor becomes the product
\[ \epsilon \cdot \Delta_I^{-1} \cdot \Delta_{III}.\]
The terms $\Delta_I$ and $\Delta_{III}$ are slightly different from the original ones, and are defined in \cite[\S4.3]{KalHDC}. Neither of them depends on auxiliary data, although they are defined on certain covers of tori, and one could argue that the elements of those covers count as auxiliary data.

We now state the theorem asserting transfer of orbital integrals. It is a fundamental result of Shelstad, \cite{She82}, \cite{SheTE1}. We state two versions, one using the cover $H(\R)_\pm$ and one using a $z$-pair $(H_1,\eta_1)$.
\begin{thm}
Let $f \in \mc{C}_c^\infty(G(\R))$.
\begin{enumerate}
	\item There exists a genuine function $f^{H_\pm} \in \mc{C}_c^\infty(H(\R)_\pm)$ such that for all $\dot\gamma \in H(F)_\pm^\tx{rs}$
	\[ SO_{\dot\gamma}(f^{H_\pm}) = \sum_\delta \Delta(\dot\gamma,\delta) O_\delta(f). \]
	\item Assume chosen a $z$-pair $(H_1,\eta_1)$. There exists a genuine function $f^{H_1} \in \mc{C}_c^\infty(H_1(\R))$ such that for all $\gamma_1 \in H_1(F)^\tx{rs}$
	\[ SO_{\gamma_1}(f^{H_1}) = \sum_\delta \Delta(\gamma_1,\delta) O_\delta(f). \]
\end{enumerate}
In both cases $\delta$ runs over the set of $G(\R)$-conjugacy classes in $G(\R)^\tx{rs}$.
\end{thm}

\begin{dfn} \label{dfn:matching}
The functions $f$ and $f^{H_\pm}$ are called \emph{matching}. The functions $f$ and $f^{H_1}$ are called \emph{matching}.
\end{dfn}

For the computations of this paper it would be useful to review a basic property of the transfer factor. The first property concerns the behavior of $\Delta$ under stable conjugacy in the variables $\gamma$ and $\delta$. If $\dot\gamma$, resp. $\gamma_1$, is replaced by a stable conjugate, then the value of $\Delta$ doesn't change. On the other hand, if $\delta$ is replaced by a stable conjugate, the value of $\Delta$ changes in the following way
\begin{equation} \label{eq:tfstab}
	\Delta(\dot\gamma,(z_2,\delta_2)) = \Delta(\dot\gamma,(z_1,\delta_1)) \cdot \<\tx{inv}((z_1,\delta_1),(z_2,\delta_2)),\hat \jmath\,^{-1}(s)\>.
\end{equation}
This is in the setting of covers and we refer to \cite[Lemma 4.3.1]{KalHDC}. In the classical setting, where $\dot\gamma$ is replaced by $\gamma_1$, we refer to \cite[Definitions 4.2.7,4.3.11]{KalIMS}, or \cite[\S4.1]{LS87}.

To explain this formula let us denote by $\gamma \in H(F)$ the image of $\dot\gamma$ resp. $\gamma_1$, and let $S \subset H$ be the centralizer of $\gamma \in H(F)$. Let $T \subset G_{z_1}$ be the centralizer of $\delta_1$. Using the discussion of \S\ref{sub:adm} we obtain from the inclusion $S \to H$ a $\Gamma$-stable $\hat H$-conjugacy class of embeddings $\hat S \to \hat H$. Composing this with the inclusion $\eta : \hat H \to \hat G$ we obtain a $\Gamma$-stable $\hat G$-conjugacy class of embeddings $\hat S \to \hat G$, hence conversely a $\Gamma$-stable $G(F^s)$-conjugacy class of embeddings $S \to G$. Among them, there is a unique one that maps $\gamma$ to $\delta_1$. It is automatically defined over $F$, and we call it $j$. Its dual-inverse $\hat\jmath^{-1}$ is an isomorphism $\hat S \to \hat T$. Composing with the canonical inclusion $Z(\hat H) \to \hat S$ we can use it to transport the element $s \in Z(\hat H)^\Gamma$ to $\hat T^\Gamma$, where it can be paired with elements of $H^1(F,T)$ by Tate-Nakayama duality. This is in the setting of pure inner twists, and the setting of rigid inner twists is analogous.


% The second property is related to the definition of $\Delta_{III}$. In the classical setting this factor depends on the choice of $\chi$-data. This choice produces $L$-embeddings $^LS \to {^LH}$ and $^LT \to {^LG}$. If we assume that $H_1=H$ and $\eta_1 : {^LH} \to {^LG}$ is an $L$-embedding, then composing we obtain $L$-embeddings $^LS \to {^LG}$ and $^LT \to {^LG}$. On the other hand we have the isomorphism $j : S \to T$ reviewed above, and it induces an $L$-isomorphism $^LS \to {^LG}$. Composing again we now have two $L$-embedings $^LS \to {^LG}$. They necessarily differ by an element of $H^1(W_\R,\hat S)$, which is the parameter of a character $\chi$ of $S(\R)$. Then $\Delta_{III}(\gamma,\delta)=\chi(\gamma)$. From this definition one sees the following property. If $\varphi : W_\R \to {^LS}$ is a the parameter of a character $\theta$ of $S(\R)$ and $\varphi' : W_\R \to {^LT}$ is the parameter of a character $\theta'$ of $T(\R)$, and if composing these parameters with $^LS \to {^LH} \to {^LG}$ and $^LT \to {^LG}$ we obtain the same parameter for $^LG$, then
% \begin{equation} \label{eq:tfd3}
% 	\Delta_{III}(\gamma,\delta) = \theta(\gamma_1,\delta))/\theta'((\gamma_1,\delta)),
% \end{equation}
% where we have transported $\theta_1$ and $\theta_1'$ to characters $\theta$ and $\theta'$ on $S_1 \times_S T$.



% The setting of non-trivial $z$-pair is similar, but more notationally heavy, and one has $\Delta_{III}(\gamma_1)=\chi(\gamma_1)$ for a character $\chi$ of $S_1(\R)$, where $S_1 \subset H_1$ is the preimage of $S$. 

Finally, we will need to review the factor $\epsilon$ and compute it in the case of the base field $\R$, where the computation is rather straightforward. Consider the universal maximal torus $T_0^G$ of $G$ and $T_0^H$ of $H$. The complexified character modules $V_G := X^*(T_0^G)\otimes_\Z\C$ and $V_H := X^*(T_0^H)\otimes_\Z\C$ are self-dual Artin representations of the same dimension. Choose an $\R$-pinning of the quasi-split form $G_0$ of $G$ and a non-trivial additive character $\Lambda : \R \to \C$, which combine to the Whittaker datum fixed for $G_0$. Then
\[ \epsilon = \epsilon(1/2,V_G-V_H,\Lambda), \]
where we have use Langlands' convention \cite[(3.6.4)]{TateCor} for the $\epsilon$-factor. The pinning is used in the construction of $G_0$.


\begin{lem} \label{lem:epsilon}
Let $\Lambda(x)=e^{irx}$ with $r>0$. Then
\[ \epsilon = (-1)^{q(H)-q(G_0)}i^{r_G/2-r_H/2}, \]
where $r_G$ is the number of roots in the absolute root system of $G$, and $r_H$ is the analogous number for $H$.
\end{lem}
\begin{proof}
Let $A_0^G \subset T_0^G$ be the maximal split torus ($X_*(A_0^G)=X_*(T_0^G)^\Gamma$), and $S_0^G \subset T_0^G$ the maximal anisotropic torus ($X^*(S_0^G)=X^*(T_0^G)/X^*(T_0^G)^\Gamma$). Then $X^*(T_0^G)_\C=X^*(A_0^G)_\C \oplus X^*(S_0^G)_\C$, where we have abbreviated $\otimes_\Z\C$ by the subscript $\C$. One has $\epsilon(1/2,\textbf{1},\Lambda)=1$ and $\epsilon(1/2,\tx{sgn},\Lambda)=i$ according to \cite[(3.2.4)]{TateCor}, hence
\[ \epsilon(1/2,V_G,\Lambda)=i^{d-\dim(A_0^G)}, \]
where $d=\dim(T_0^G)$. We use the same computation for $H$ and conclude
\[ \epsilon=\frac{\epsilon(1/2,X^*(T_0^G)_\C,\Lambda)}{\epsilon(1/2,X^*(T_0^H)_\C,\Lambda)} = \frac{i^{d-\dim(A_0^G)}}{i^{d-\dim(A_0^H)}}=i^{\dim(A_0^H)-\dim(A_0^G)}. \]

The Iwasawa decomposition $\tx{Lie}(G_0)=\mf{a} \oplus\mf{n} \oplus \mf{k}$ shows  $2q(G_0)=\dim(\mf{a})+\dim(\mf{n})=\dim(A_0^G)+r_G/2$. We note that $q(G_0)$ is an integer, becaus e $G_0$ has an elliptic maximal torus, and $q(G_0)$ equals the number of positive non-compact roots with respect to any Weyl chamber. Therefore
\[ \dim(A_0^H)-\dim(A_0^G) = 2(q(H)-q(G_0))+(r_G/2-r_H/2).\qedhere \]
\end{proof}

\section{Genericity of discrete series representations} \label{sec:gen}

From the work of Kostant \cite{Kos78} and Vogan \cite{Vog78} it is known that every essentially discrete series representation is generic for some Whittaker datum. In this section we will prove a more precise statement (Proposition \ref{p:whittaker}) that gives a link between the representation and the Whittaker datum. It provides  (Corollary \ref{cor:gen}) an exact analog of a result in the p-adic case, originally due to DeBacker and \cite[Proposition 4.10]{DR10} under unramifiedness assumptions, but whose proof applies in much greater generality, see \cite[Lemma 6.2.2]{KalRSP} and \cite[\S4.4]{FKS}. This allows us to prove the strong form of Shahidi's generic packet conjecture \cite[\S9]{Sha90} for discrete series packets, originally established by Shelstad \cite{SheTE3} using a less direct argument. Note that the general form of the conjecture (for tempered $L$-packets) reduces immediately to the case of discrete $L$-packets.

\subsection{Whittaker data and Kostant sections} \label{sub:whit}

We assume that $G$ is a quasi-split connected reductive $\R$-group. Suppose $B$ is a Borel $\R$-subgroup of $G$, $N$ its unipotent radical, and $\n=\mathrm{Lie}(N)$. Since $N(\R)$ is a connected Lie group, any character $\eta : N(\R) \to \C^\times$ is determined by its differential $d\eta : \n(\R) \to \C$, which is an $\R$-linear form. We have $\eta(\exp(Y))=e^{\<d\eta,Y\>}$ for $Y \in \n(\R)$. In fact, the real Lie group $N(\R)$ is connected, nilpotent, and simply connected (see \cite[Theorem 6.46]{KnappLie}, where the assumption that $G$ is semi-simple is unnecessary) and  hence the exponential map $\exp : \n(\R) \to N(\R)$ is a diffeomorphism by \cite[Theorem 1.127]{KnappLie}.

An $\R$-linear form $\n(\R) \to \C$ can be obtained as the restriction of a $\C$-linear form $\n(\C) \to \C$. Let $\bar N$ be the unipotent radical of $B$ that is $T$-opposite to $N$. Since the Killing form $\kappa$ induces a non-degenerate $\C$-linear pairing $\n \times \bar\n \to \C$, such forms are in 1-1 correspondence with elements of $\bar\n(\C)$. Given $X \in \bar\n(\C)$ we thus obtain the character $\eta_X(\exp(Y))=e^{\kappa(X,Y)}$. It is unitary if and only if $X \in i\bar\n(\R)$. 


Given a maximal torus $T\subset B$ defined over $\R$, the space $\n(\R)$ decomposes as the direct sum of relative root spaces, with respect to the action of the split part of $T$. We say a character $\eta: N(\R) \to \C^\times$ is \emph{non-degenerate} if its differential $d\eta$ restricts non-trivially to any relative root space in $\n(\R)$. Since all choices of $T$ are conjugate under $N(\R)$, this condition is independent of $T$. For $\eta_X$ with $X \in i\bar\n(\R)$ we can write $X=\sum_\alpha X_{-\alpha}$ where the sum runs over the set of absolute positive roots and $X_{-\alpha} \in \mf{g}_{-\alpha}$. Then $\eta_X$ is non-degenerat if and only if $X_{-\alpha} \neq 0$ for all simple roots $\alpha$, i.e. if and only if $X$ is a regular nilpotent element.

By a  {\it Whittaker datum} we mean a $G(\R)$-conjugacy class of  pairs  $(B,\eta)$ where $B$ is a Borel subgroup defined over $\R$
and $\eta$ is a non-degenerate unitary character of $N(\R)$. We  write $\w=[(B,\eta)]$ for it $G(\R)$-conjugacy class of $(B,\eta)$.

Suppose $X\in i\g(\R)$ is a regular nilpotent element. Let $\overline B$ be the unique Borel subgroup 
containing $X$. Then $\overline B$ is defined over $\R$. Let $B$ be an $\R$-Borel subgroup that is opposite to $\bar B$, i.e. such that $B \cap \bar B$ is a maximal torus. The Whittaker datum defined by $X$ is  $\w_X=[(B,\eta_X)]$.

\begin{lem}
	The Whittaker datum $\w_X$ depends only on the $G(\R)$-conjugacy class of $X$.
\end{lem}
\begin{proof}
The choice of $B$ is equivalent to a choice of a maximal torus $T \subset \bar B$ defined over $\R$, because $T$ is determined by $B$ as $T=B \cap \bar B$ and $B$ is determined by $T$ as the unique $T$-opposite of $\bar B$. But all maximal $\R$-tori in $\bar B$ are conjugate under $\bar B(\R)$ by \cite[Theorem 19.2]{Bor91}.
\end{proof}

There is a similar but slightly different way to obtain a Whittaker datum. Let $(T,B,\{X_\alpha\})$ be an $\R$-pinning of $G$ and let $\Lambda : \R \to \C^\times$ be a non-trivial unitary character. The element $X_\alpha$ specifies an isomorphism $u_\alpha$ from $\mb{G}_a$ to the root group $U_\alpha$ of $G$ associated to the absolute root $\alpha$, namely the unique isomorphism whose differential maps $1$ to $X_\alpha$. If $N$ is the unipotent radical of $B$ then the composition $\prod_{\alpha \in \Delta} U_\alpha \to N \to N/[N,N]$ is an isomorphism of complex algebraic groups, which we compose with $(u_\alpha)$. The inverse of the result, composed with the product map $\prod_\alpha \mb{G}_a \to \mb{G}_a$, becomes a homomorphism of algebraic groups $N/[N,N] \to \mb{G}_a$ defined over $\R$, which leads to a homomorphism $N(\R) \to \R$. Composing that with the character $\Lambda$ provides a non-degenerate unitary character $\psi : N(\R) \to \C^\times$. The $G(\R)$-conjugacy class of the pair $(B,\psi)$ is a Whittaker datum and depends only on the $G(\R)$-conjugacy class of the pinning $(T,B,\{X_\alpha\})$.

\begin{lem} \label{lem:w1}
Let $(T,B,\{X_\alpha\})$ be an $\R$-pinning of $G$ and let $\Lambda(x)=e^{2\pi i x}$. Then the Whittaker datum associated to this pinning and character by the above procedure is equal to the Whittaker datum $\w_{\bar X}$, where $\bar X=2\pi i\sum_{\alpha \in \Delta} X_{-\alpha}$, where $X_{-\alpha} \in \mf{g}_{-\alpha}$ is determined by the rule $[X_\alpha,X_{-\alpha}]=H_\alpha$. 
\end{lem}
\begin{proof}
Set $X_-=\sum_{\alpha \in \Delta} X_{-\alpha}$. Then $X_-$ is a regular nilpotent element of the Lie algebra of $G$ and is fixed by the Galois action, hence an $\R$-point. It lies in $\bar\n$, the Lie algebra of the unipotent radical of the Borel subgroup $T$-opposite to $B$. Thus $\bar X \in i\bar\n(\R)$ is also regular nilpotent. 

Given $Y \in \n(\R)$ write it as $\sum_{\alpha \in \Delta} y_\alpha \cdot X_\alpha + Y'$ with $Y' \in [\n,\n](\R)$. Then
we have
\[ \kappa(Y, X_-)= \sum_{\alpha \in \Delta} y_\alpha \kappa(X_\alpha,X_{-\alpha}) =\sum_{\alpha \in \Delta} y_\alpha, \]
therefore
\[ \psi_{\bar X}(\exp(Y)) = e^{\kappa(Y,\bar X)}=e^{2\pi i \kappa(Y,X_-)} = \Lambda(\sum_{\alpha \in\Delta}y_\alpha) = \psi(\exp(Y)), \]
where $\psi : N(\R) \to \C^\times$ is constructed from the pinning and $\Lambda$ as above.
\end{proof}

Suppose $X\in\g$ is a regular nilpotent element. Choose an
$SL(2)$-triple $[X,H,Y]$ [reference].  The {\it Kostant Section} $\K(X)$ of
$X$ is the affine space $X+\Cent_\g(Y)$.
Kostant showed \cite{Kos63} that the Kostant section meets every regular orbit in a unique point. If the tripple lies in $\g(\R)$, then $\K(X)$ is Galois stable. The Kostant section $\K(X)$ depends on a choice of
triple, but any two such choices that lie in $\g(\R)$ are $G(\R)$-conjugate, and the $G(\R)$-conjugacy class of $\K(X)$ only depends on the $G(\R)$-conjugacy class of $X$.

Suppose $X\in \g(\R)$ and $\O$ is a regular orbit which is defined over $\R$.
Then, since $X$ is also defined over $\R$, the unique point in $\K(X)\cap \O$ is contained in $\g(\R)$. The $G(\R)$-orbit of $\K(X)\cap \O$ depends only on the $G(\R)$-orbit of $X$.

\subsection{Generic discrete series representations} \label{sub:gen}

\begin{dfn}
Suppose $\w=[(B,\eta)]$ is a Whittaker datum. We say that a representation $\pi$ of $G$ is $\w$-generic if there is a non-zero smooth vector $v$ in the space of $\pi$ such that $\pi(X)(v)=\eta(v)$ for all $x\in \n(\R)$. We say $\pi$ is generic if it is $\w$-generic for some $\w$. \warn{Jeff, do you want $\pi(x)v=\eta(x)$ for all $x \in N(\R)$, or $d\pi(X)v=d\eta(X)$ for all $X \in \n(\R)$?}
\end{dfn}

Suppose $\pi$ is an irreducible essentially discrete series representation and write $\pi=\pi(S,\tau)$ as in Section  \ref{sub:essds}. Let $H_\pi$ be the element of $i\s(\R)$ corresponding to $d\tau$ via $\kappa$. The $G(\R)$-conjugacy class of $H_\pi$ is well defined. The purpose of this subsection is to prove the following result.

	

\begin{pro}
  \label{p:whittaker}
Suppose $\pi$ is a generic discrete series representation. Then $\pi$ is $\w$-generic
for a unique Whittaker datum $\w$.
Write $\w=\w_X$ for some regular nilpotent element $X\in i\g(\R)$.
Then $H_\pi\in i\s(\R)$ is $G(\R)$-conjugate to an element of the Kostant section of $X$.
\end{pro}

We begin with some preparations. If $W$ is a subset of a real or complex vector space $V$, define  $\AC(W)$,  the  {\it asymptotic cone} of $W$ as in   \cite[Proposition 3.7]{bvlocal}, \cite[Definition 2.9]{avav}:
$$
\AC(W)=\{v\in V\mid \exists t_i\in \R_{>0},t_i\rightarrow 0,w_i\in W,\lim_{i\rightarrow\infty}t_i w_i=v\}
$$
This is a closed cone. 
%If $\O$ is a $G(\R)$-orbit it  is a finite union of nilpotent orbits in $\g(\R)$.

\begin{lem}
Let $\O_\R\subset \g(\R)$ be a regular $G(\R)$-orbit. Assume there exists a regular nilpotent element $X\in\AC(\O_\R)$. Then $\K(X)$ meets $\O_\R$.
\end{lem}

\begin{proof}
Let $\O_\C$ be the $G(\C)$-orbit of $\O_\R$. It is a regular orbit defined over $\R$ and hence meets $\K(X)$ in a unique point, which lies in $\O_\C(\R)$.

By definition of $AC(\O_\R)$, the distance (in a Euclidean metric on $\mf{g}(\R)$) between $t\O_\R$ and $X$ goes to zero as $t \to 0$.

	Let $\O_X$ be the $G(\C)$-orbit of $X$.
By \cite{Kos63} \warn{Can you give a more precise reference?} $\K(Y)$ is transverse to $\O_X$ for any $Y\in \O_X$.
Since $\O_\R$ and $\K(Y)$ are defined over $\R$, we also have
$\K(Y)(\R)$ is transverse to $\O_X(\R)$.

By the definition of $\AC(\O_\R)$, $tX$ approaches $\O_\R$ as $t\rightarrow\infty$. 
By transversality this says $\O_\R\cap \K(tX)(\R)\ne \emptyset$ for $t>>0$.
But $tX$ is $G(\R)$-conjugate to $X$ so $\O_\R\cap \K(X)$ is also non-empty.
\end{proof}

\begin{proof}[Proof of Proposition \ref{p:whittaker}]
Suppose $\pi$ is $\w_X$-generic.
By \cite[Theorem A]{matumoto} $X\in \WF(\pi)$. By \cite[Theorem 1.2]{harris} $\WF(\pi)=\AC(G(\R)\cdot H_\pi)$.
The proposition then follows from the Lemma (applied with $i\g(\R)$ in place of $\g(\R))$.
\end{proof}


\begin{rem}
  The maps $\pi\rightarrow H_\pi$ and $\w\rightarrow X$ both depend on the choice of $\kappa$.
  This dependence is very minor (only on the center), and in any event these two choices cancel so the statement of the Proposition
  is independent of the choice of $\kappa$.
\end{rem}

% Here is an alternative formulation.
% \begin{pro}
% \label{p:whittakeralt}
% Suppose $\pi$ is a generic discrete series representation. Then $\pi$ is $\w$-generic
% for a unique Whittaker datum $\w$.
% Write $\pi=\pi(S,\tau)$, and let $\ch\rho=\frac12\sum_{\langle d\tau,\ch\alpha\rangle>0}\ch\alpha$. 
% Write $\w=\w_X$ for some regular nilpotent element $X\in i\g(\R)$.
% Then $\ch\rho(i)\in\s(\R)$ is $G(\R)$-conjugate to the Kostant section of $iX\in \g(\R)$.
% \end{pro}
  
\begin{cor} \label{cor:gen}
Let $S \subset G_0$ be an elliptic maximal torus, $\rho$ a Weyl chamber in $X^*(S/Z_{G_0})$, and $\tau_0$ a character of $S(\R)$ whose differential is $\rho$-dominant and $\rho$-integral. Let $(T_0,B_0,\{X_\alpha\})$ be a pinning of $G_0$ and $\Lambda(x)=e^{2\pi ix}$. If the discrete series representation associated to $(S,\rho,\tau_0)$ is generic with respect to the Whittaker datum associated to the pinning and $\Lambda$, then the element $\rho^\vee(-i) \in \tx{Lie}(S_\tx{sc})(\R)$ is $G_0(\R)$-conjugate to the Kostant section associated to the pinning.
\end{cor}
\begin{proof}
Let $\pi$ be the essentially discrete series representation associated to $(S,\rho,\tau_0)$ and let $H_\pi \in i\tx{Lie}(S)(\R)$ be the associated element, determined by $d\tau(Z)=\kappa(H_\pi,Z)$. 

Let $X_-=\sum_{\alpha \in \Delta} X_{-\alpha}$ and let $\bar X=2\pi i X_-$. According to Lemma \ref{lem:w1}, being generic with respect to the pinning and $\Lambda$ is equivalent to being generic with respect to $\w_{\bar X}$, and Proposition \ref{p:whittaker} implies that $H_\pi$ is $G(\R)$-conjugate to the Kostant section $K(\bar X)$.

Let $H=\rho^\vee(i) \in \tx{Lie}(S_\tx{sc})$. This element is Galois-fixed and thus lies in $\tx{Lie}(S_\tx{sc})(\R)$. \warn{Argue from above statement to the fact that $H$ is $G(\R)$-conjugate to the Kostant section $K(i\bar X)$.} But $K(i\bar X)=K(-2\pi X_-)$ and we conclude that $\rho^\vee(-i)$ is $G(\R)$-conjugate to $K(2\pi X_-)$.
\end{proof}

\subsection{An example with $\tx{SL}_2$}

Set $G=\SL(2,\R)$. Let $\s(\C)=\{t_z\mid z\in\C\}$ where
$$
t_z=\begin{pmatrix}0&z\\-z&0
\end{pmatrix}
$$
Then $\s(\R)=\{t_x\mid x\in\R\}$.

For $z\in \C$ define $\lambda_z\in \s(\C)^*$ by $\lambda_z(t_x)=xz$.
The positive root is  $\alpha(t_z)=2iz$, i.e.
$$
\alpha=\lambda_{2i},\quad \rho=\lambda_i.
$$
and
$$
\ch\alpha=t_{-i}, \quad \ch\rho=t_{-i/2}
$$
In particular
$$
\ch\rho(-i)=t_{-\frac 12}=\begin{pmatrix}0&-\frac 12\\\frac 12&0
\end{pmatrix}
$$

Define $H_{\lambda}\in \s(\C)$ so that $\kappa(H_\lambda,t_x)=\lambda(t_x)$. Then $H_{\lambda_z}=t_{-\frac z8}$:
$$
H_{\lambda_z}=t_{\frac{-z}8}=
\begin{pmatrix}0&-\frac{z}8\\\frac{z}8&0
\end{pmatrix}
$$
Take $z=ik$, so
$$
H_{\lambda_{ik}}=
\begin{pmatrix}0&-\frac{ik}8\\\frac{-ik}8&0
\end{pmatrix}
$$

Let $\pi(\lambda_{ik})$ be the discrete series representation with Harish-Chandra parameter $\lambda_{ik}$ $(k\in \Z_{\ne 0})$.
If $\pi=\pi(\lambda)$ let $H_\pi=H_\lambda\in i\s(\R)^*$.

For an $SL(2)$-triple we can take $\{X_\alpha,X_{-\alpha},t_{-i}\}$ where
$$
X_\alpha=\frac12\begin{pmatrix}1&i\\i&-1
\end{pmatrix}, \quad X_{-\alpha}=\overline{X_\alpha}.
$$
The Killing form satisfies
$$
\kappa(t_x,t_y)=-8xy.
$$



Conjugating this by $\mathrm{diag}(x,\frac 1x)$ takes it to
$\begin{pmatrix}0&-x^2\frac{ik}8\\\frac{ik}{x^2}&0
\end{pmatrix}$,
and taking the limit we see
$$
\AC(G(\R)\cdot H_{\lambda_{ik}})=
\begin{cases}
  \R^+*\begin{pmatrix}0&-i\\0&0
  \end{pmatrix}&k>0\\
    \R^+*\begin{pmatrix}0&i\\0&0
  \end{pmatrix}&k<0\\
  \end{cases}
$$
Therefore
$$
\WF(\pi(\lambda_{ik}))
=
\begin{cases}
  \R^+*\begin{pmatrix}0&-i\\0&0
  \end{pmatrix}&k>0\\
    \R^+*\begin{pmatrix}0&i\\0&0
  \end{pmatrix}&k<0\\
  \end{cases}
$$

Note that
$$
\K
\begin{pmatrix}0&-i\\0&0
\end{pmatrix}=\{\begin{pmatrix}0&-i\\z&0
\end{pmatrix}\mid z\in\C\}
$$
and
$$
\K\cap i\g(\R)=
\{\begin{pmatrix}0&-i\\iy&0
\end{pmatrix}\mid y\in\R\}
$$
In particular
$$
\K\begin{pmatrix}0&-i\\0&0\end{pmatrix}\cap i\g(\R)\ni H_\pi=\begin{pmatrix}0&-\frac{ik}8\\\frac{ik}8&0\end{pmatrix}\quad (k>0)
$$
as required by Proposition \ref{p:whittaker}.
Similarly
$$
\K\begin{pmatrix}0&i\\0&0\end{pmatrix}\cap i\g(\R)\ni H_\pi=\begin{pmatrix}0&-\frac{ik}8\\\frac{ik}8&0\end{pmatrix}\quad (k<0).
$$

In this case Proposition \ref{p:whittakeralt} amounts to 
$$
\K(-iX)=\K\begin{pmatrix}0&-1\\0&0
\end{pmatrix}\ni \ch\rho(-i)=
\begin{pmatrix}
  0&-\frac 12\\\frac 12&0
\end{pmatrix}\quad (k>0)
$$
and
$$
\K(-iX)=\K\begin{pmatrix}0&1\\0&0
\end{pmatrix}\ni \ch\rho(-i)=
\begin{pmatrix}
  0&\frac 12\\-\frac 12&0
\end{pmatrix}\quad (k<0)
$$

Note that the coroot $\ch\alpha:\C^\times \rightarrow S$ is given by
$$
\ch\alpha(e^z)=\begin{pmatrix}\cos(z)&\sin(z)\\-\sin(z)&\cos(z)
\end{pmatrix}
$$
or more algebraically
$$
\ch\alpha(z)=\begin{pmatrix}
\frac{z+\frac 1z}2&\frac{z-\frac 1z}{2i}\\
-\frac{z-\frac 1z}{2i}&\frac{z+\frac 1z}2
\end{pmatrix}.
$$


\section{Construction of $L$-packet and internal structure}

Let $G_0$ be a quasi-split connected reductive $\R$-group with dual group $\hat G$ and $L$-group $^LG$.
%We choose an $\R$-pinning $(T,B,\{X_\alpha\})$ of $G$ and a non-trivial additive character $\psi : \R \to \C^\times$ and denote by $\mf{w}$ the resulting Whittaker datum, as in \S\ref{sec:whit}.
Let $[\varphi] : W_\R \to {^LG}$ be a $\hat G$-conjugacy class of discrete Langlands parameters.

\subsection{Factorization of a parameter}


Choose any representative $\varphi$ within the conjugacy class $[\varphi]$. There exists a maximal torus $\hat T \subset \hat G$ satisfying $\varphi(z) \in \hat T$ for all $z \in \C^\times$ \warn{why}. The restriction $\varphi|_{\C^\times}$ is a continuous group homomorphism $\C^\times \to \hat T$. Every continuous group homomorphism $\C^\times \to \C^\times$ is of the form $z^a\bar z^b = |z|^{a+b}\tx{arg}(z)^{a-b}$ for unique $a,b \in \C$ with $a-b \in \Z$. Thus there exist unique $\lambda,\mu \in X_*(\hat T)\otimes_\Z\C$ with $\lambda-\mu \in X_*(\hat T)$ such that
\[ \varphi(z) = \lambda(z) \cdot \mu(\bar z),\qquad \forall z \in \C^\times. \]

\begin{lem} \label{lem:icreg}
Assume that $G_0$ is semi-simple and simply connected.
\begin{enumerate}
	\item $\lambda,\mu \in X_*(\hat T)$
	\item $\<\lambda,\alpha\> \neq 0$ for all $\alpha \in R(\hat T,\hat G)$.
	\item $\mu=-\lambda$ in $X_*(\hat T/Z(\hat G))$
\end{enumerate}
\end{lem}
\begin{proof}
\warn{TODO.}
\end{proof}

We can apply Lemma \ref{lem:icreg} to the composition of $\varphi$ with the projection $^LG \to {^LG}/\hat Z$, where $\hat Z$ is the center of $\hat G$, noting that $\hat G/\hat Z$ is the dual group of $G_\tx{sc}$. It implies that the image $\bar\lambda \in X_*(\hat T/\hat Z)_\C$ of $\lambda$, which according to the lemma lies in $X_*(\hat T/\hat Z)$, is regular. In particular, $\hat T$ is unique determined as the centralizer of $\varphi(\C^\times)$ in $\hat G$.
%Conjugating $\varphi$ by $N(\hat T,\hat G)$ we may then assume that this image lies in the chamber determined by $\hat B$. This will be used in Lemma \ref{lem:a} below.
%
% At this point, $\varphi$ is well-defined up to conjugation by $\hat T$. This of course depends on the chosen Borel pair $(\hat T,\hat B)$.
%
Since $\C^\times$ is normal in $W_\R$, the image of $\varphi$ lies in $N(\hat T,\hat G)$. Its projection to $\Omega(\hat T,\hat G)$ factors through a homomorphism $\xi : \Gamma \to \Omega(\hat T,\hat G) \rtimes \Gamma$. Let $\hat S$ denote the $\Gamma$-module with underlying abelian group $\hat T$ and $\Gamma$-structure given by $\tx{Ad}\circ\xi$. Let $S$ be the $\R$-torus whose dual is $\hat S$, i.e. the $\R$-torus determined by $X^*(S)=X_*(\hat S)$ as $\Gamma$-modules.


By construction we have $R(\hat T,\hat G) \subset X^*(\hat T)=X^*(\hat S)=X_*(S)$, and we write $R^\vee(S,G)$ for this set. Analogously we have a subset $R(S,G) \subset X^*(S)$. Both of these subsets are $\Gamma$-stable. Moreover $\mu=\sigma\lambda$ in $X_*(\hat S)$ and according to Lemma \ref{lem:icreg} the action of $\sigma$ on $R(S,G)$ is by negation.

Let $S(\R)_G$ be the double cover of $S(\R)$ reviewed in \S\ref{sub:covtori}, associated to the subset $R(S,G) \subset X^*(S)$. As discussed there, there is a canonical $\hat G$-conjugacy class of $L$-embeddings $^LS_G \to {^LG}$. Inside of this class, there is a unique $\hat S$-conjugacy class, call it $^Lj$, whose restriction to $\hat S$ is the tautological embedding $\hat S \to \hat G$. The image of this $L$-embedding is described in \eqref{eq:lembim}, and contains the image of $\varphi$ by construction. Thus $\varphi = {^Lj}\circ\varphi_S$ for a unique $\hat S$-conjugacy class of $L$-homomorphisms $\varphi_S : W_\R \to {^LS_G}$. According to \cite[Theorem 3.15]{KalDC}, $\varphi_S$ corresponds to a genuine character $\tau : S(\R)_G \to \C^\times$.

Finally, the tautological inclusion $\hat T \subset \hat G$ provides an embedding $\hat\jmath : \hat S \to \hat G$. While this embedding is not $\Gamma$-equivariant, its $\hat G$-conjugacy class is, because the embedding $\hat T \to \hat G$ is $\Gamma$-equivariant and the $\Gamma$-structures of $\hat T$ and $\hat S$ differ by twisting by $N(\hat T,\hat G)$.

The construction of $(S,\tau,\hat\jmath\,)$ depended on the choice of $\varphi$ within its conjugacy class. The next lemma shows that this dependence is irrelevant.

\begin{lem} \label{lem:a}
If $(S_1,\tau_1,\hat\jmath_1)$ and $(S_2,\tau_2,\hat\jmath_2)$ are two pairs obtained from two different choices $\varphi_1$ and $\varphi_2$ of elements of the $\hat G$-conjugacy class $[\varphi]$, there exists a unique isomorphism $S_1 \to S_2$ which identifies $\tau_1$ with $\tau_2$ and whose dual intertwines $\hat\jmath_1$ and $\hat\jmath_2$. It is given by conjugation by an element of $\hat G$.
\end{lem}
\begin{proof}
	The uniqueness claim is clear from the compatibility with $\hat\jmath_i$. We show existence. Let $\hat T_i$ be the centralizer of $\varphi_i(\C^\times)$, a maximal torus according to Lemma \ref{lem:icreg}. Choose any $g \in \hat G$ such that $\tx{Ad}(g) \circ\varphi_1=\varphi_2$. Then $\tx{Ad}(g)\hat T_1=\hat T_2$ and the isomorphism $\tx{Ad}(g) : \hat T_1 \to \hat T_2$ translates the $\Gamma$-action induced by $\tx{Ad}\circ\varphi_1$ to that induced by $\tx{Ad}\circ\varphi_2$. Therefore, $\tx{Ad}(g) : \hat S_1 \to \hat S_2$ is $\Gamma$-equivariant. Tautologically, it intertwines $\hat\jmath_1$ and $\hat\jmath_2$.

	The dual isomorphism $S_2 \to S_1$ identifies the subsets $R(S_1,G) \subset X^*(S_1)$ and $R(S_2,G) \subset X^*(S_2)$, hence lifts canonically to an isomorphism of double covers $S_2(\R)_G \to S_1(\R)_G$. Dually the isomorphism $\hat S_1 \to \hat S_2$ extends canonically to an isomorphism $^LS_{1,G} \to {^LS_{2,G}}$, which commutes with the canonical $L$-embeddings into $^LG$. Therefore, it translates the factorization of $\varphi_1$ through $^LS_{1,G}$ to the factorization of $\varphi_2$ through $^LS_{2,G}$, which implies that the isomorphism $S_2(\R)_G \to S_1(\R)_G$ identifies $\tau_2$ with $\tau_1$.
\end{proof}

% \begin{cns} \label{cns:stj}
% 	Let $(G,\xi)$ be an inner twist of $G_0$. We construct a natural stable class $J_\xi$ of embeddings $j : S \to G$. \warn{TODO} Choose, in addition to the $\Gamma$-stable Borel pair $(\hat T,\hat B)$ of $\hat G$, an $F$-Borel pair $(T_0,B_0)$ of $G_0$. The resulting identification $X_*(T_0)=X^*(\hat T)$ induces a $\Gamma$-equivariant identification of Weyl groups $\Omega(\hat T,\hat G) = \Omega(T_0,G_0)$, and we obtain the homomorphism $\xi : \Gamma \to \Omega(T,G) \rtimes \Gamma$.
% \end{cns}
	

\subsection{Construction of the $L$-packet}

% Recall that $\theta$ has regular differential. It determines a choice of positive roots in $R(S,G)$, which we denote by $\alpha>0$. The function
% \[ \Theta : S(\R)_G \to \C,\qquad \dot x \mapsto \frac{\theta(\dot x)}{\prod_{\alpha>0}(\alpha^{1/2}(\dot x)-\alpha^{-1/2}(\dot x))} \]
% is non-genuine, i.e. it descends to $S(\R)$. Indeed, if we set $\theta'(x)=\theta(\dot x)\cdot \rho(\dot x)^{-1}$, then this function can also be written as
% \[ \Theta(x) = \frac{\theta'(x)}{\prod_{\alpha>0}(1-\alpha^{-1}(x))}.\]
% We will use it to specify the elements of the $L$-packet associated to $\varphi$.

The natural embedding $\hat S \to \hat G$ is not $\Gamma$-equivariant, but its $\hat G$-conjugacy class is. From \S\ref{sub:adm} we obtain the category $\mc{J}$ of embeddings of $S$ into all pure (or rigid) inner forms of $G_0$.

Consider $(G,\xi,z,j) \in \mc{J}(F)$. As discussed in \S\ref{sub:essds}, there exists a unique essentially discrete series representation $\pi_j$ of $G(\R)$ associated to the pair $(S,\tau)$, transported to $G$ via $j$. According to \S\ref{sub:essds} the representation $\pi_j$ depends on the $G(\R)$-conjugacy class of $j$, and two distinct such conjugacy classes produce two non-isomorphic representations.


% The images of all elements of $J_\xi$ are elliptic maximal tori in $G$. According to \warn{ref}, these are conjugate to each other under $G(\R)$. To simplify notation we fix one elliptic maximal torus $S' \subset G$ and we write $J_\xi'$ for the subset of $J_\xi$ consisting of all elements with image $S'$. Then $J_\xi'$ is a torsor under $\Omega(S',G)(\R)$.


\begin{dfn}
We define the pure (resp rigid) compound $L$-packet
\[ \tilde\Pi_\varphi = \{(G,\xi,z,\pi_j)|(G,\xi,z,j) \in \mc{J}(F)\} \subset \tilde\Pi, \]
\[ \Pi_\varphi=\tilde\Pi_\varphi/G_0(\C) \subset \Pi. \]
For each pure (or rigid) inner twist $(G,\xi,z)$ of $G_0$, we define
\[ \Pi_\varphi(G,\xi,z)=\{\pi | (G,\xi,z,\pi) \in \tilde\Pi_\varphi\}. \]
\end{dfn}

\begin{lem}
The set of representations $\Pi_\varphi((G,\xi,z))$ equals $\{\pi_j|j \in J^G(\R)/G(\R))\}$. In particular, it is independent of $z$. It coincides with the set $\Pi_\varphi(G)$ constructed by Langlands in \cite[\S3]{Lan89}.
\end{lem}
\begin{proof}
	As discussed in \S\ref{sub:adm}, the set of $(G,\xi,z,j) \in \mc{J}(\R)$ with fixed triple $(G,\xi,z)$ corresponds to $J^G(\R)$, in particular is independent of $z$. Since the images of the members of $J^G(\R)$ are elliptic maximal tori, and all such are conjugate under $G(\R)$, we can choose representatives of $J^G(\R)/G(\R)$ that all have the same image, call it $S' \subset G$. Then these representatives are a single orbit under $\Omega(S',G)$. In other words, if $\tau'$ is the transport of $\tau$ under one admissible embedding $j : S \to G$ with image $S'$, then all others make out the $\Omega(S',G)$-orbit of $\tau'$. Since we have specified the representations $\pi_j$ by their character values on regular elements of $S'(\R)$ in the same way as in \cite[\S3]{Lan89} or \cite[\S4]{AV16}.
\end{proof}

We have thus recovered the $L$-packets constructed by Langlands. At the moment they do not depend on the datum $z$ in the triple $(G,\xi,z)$. This datum will play a role in the internal parameterization of these packets, to which we turn next.

\subsection{Internal structure of the compound packet} \label{sub:intstr}


Recall from Lemma \ref{lem:simtrans} that the abelian group $H^1(\Gamma,S)$ in the pure case (resp. $H^1(u \to W,Z(G_0) \to S)$ in the rigid case) acts simply transitively on the set $\mc{J}(\R)/G_0(\C)$. By construction we have a bijection $\mc{J}(\R)/G_0(\C) \to \Pi_\varphi$. At the same time, Lemma \ref{lem:icreg} provides an identification $S_\varphi = \hat S^\Gamma$, hence by Tate-Nakayama duality $\pi_0(S_\varphi)^*=\pi_0(\hat S^\Gamma)^*=H^1(\Gamma,S)$. Analogously, in the rigid setting we obtain $\pi_0(S_\varphi^+)^*=H^1(u \to W,Z(G_0) \to S)$. This provides a simply transitive action of the abelian group $\pi_0(S_\varphi)^*$ in the pure setting, and $\pi_0(S_\varphi^+)^*$ in the rigid setting, on the set $\Pi_\varphi$.

\begin{lem} \label{lem:uniqgen}
The set $\Pi_\varphi((G_0,1,1))$ contains a unique $\mf{w}$-generic member.
\end{lem}
\begin{proof}
Choose a $G_0$-equivariant extension $\kappa$ to $\mf{g}$ of the Killing form on $[\mf{g},\mf{g}]$. Its pull-back to $\mf{s}$ along any embedding $j \in J^{G_0}$ is the same, since all these embeddings are conjugate under $G_0$.

Let $H \in i\mf{s}(\R)$ be the element such that $\kappa(H,Y)=d\tau(Y)$ for all $Y \in \mf{s}(\R)$. For $j \in J^{G_0}(\R)$, the element $dj(H) \in i\mf{g}(\R)$ is associated to the representation $\pi_j$ as in Proposition \ref{p:whittaker}, which implies that $\pi_j$ is $\mf{w}$-generic if and only if $dj(H)$ meets the associated Kostant section. But as $j$ varies over $J^{G_0}(\R)/G_0(\R)$, the element $dj(H)$ varies over the $G_0(\R)$-classes in a fixed stable class. Therefore, $dj(H)$ meets any Kostant section for precisely one $j \in J^{G_0}(\R)/G_0(\R)$. At the same time, $j \mapsto \pi_j$ is a bijection from $j \in J^{G_0}(\R)/G_0(\R)$ to $\Pi_\varphi((G_0,1,1))$ by construction of the latter.
\end{proof}

Taking the unique $\mf{w}$-generic member of $\Pi((G_0,1,1)) \subset \Pi_\varphi$, provided by Lemma \ref{lem:uniqgen}, as a base-point, the simply-transitive action turns into the bijection from 
\[ \iota_\mf{w} : \pi_0(S_\varphi)^* \to  \Pi_\varphi, \quad \tx{resp.}\quad \iota_\mf{w} : \pi_0(S_\varphi^+)^* \to \Pi_\varphi. \]

We can summarize the construction and internal structure of $\Pi_\varphi$ as follows. We use the language of pure inner forms; that of rigid inner forms is entirely analogous. We use the simplified notation to write $\tilde\Pi$ for the set of pairs $(z,\pi)$, where $z \in Z^1(\R,G_0)$ and $\pi$ an isomorphism class of representations of the twist $G_z$, and $\Pi=\tilde\Pi/G_0(\C)$. Then $\tilde\Pi_\varphi \subset \tilde\Pi$ is the image of the map $\mc{J}(F) \to \tilde\Pi$ sending $(z,j)$ to $(z,\pi_j)$. The group $Z^1(\R,S)$ acts on $\mc{J}(\R)$ by $x\cdot (z,j)=(x \cdot z,j)$. If $j_\mf{w} : S \to G_0$ is an embedding for which $\pi_{j_\mf{w}}$ is $\mf{w}$-generic, then we obtain the map $Z^1(\R,S) \to \mc{J}(\R)$ sending $x$ to $(x,j_\mf{w})$. Composing this with the map $\mc{J}(\R) \to \tilde\Pi_\varphi$ and taking quotient under the action of $G_0(\C)$ produces the bijection $H^1(\R,S) \to \Pi_\varphi$, which, together with the isomorphism $\pi_0(S_\varphi)^*=H^1(\R,S)$ produces the desired bijection $\iota_\mf{w} : \pi_0(S_\varphi)^* \to \Pi_\varphi$.

\subsection{Dependence on the choice of Whittaker datum} \label{sub:whitdep}

In order to obtain the bijection from $\pi_0(S_\varphi)^*$ (resp,. $\pi_0(S_\varphi^+)^*)$ to $\Pi_\varphi$, we had to choose a Whittaker datum $\mf{w}$ and apply Lemma \ref{lem:uniqgen}. Another Whittaker datum is of the form $\mf{w'}=\tx{Ad}(\bar g)\mf{w}$ with $\bar g \in G_{0,\tx{ad}}(\R)$. According to Proposition \ref{p:whittaker}, if $\pi$ is $\mf{w}$-generic, then $\tx{Ad}(\bar g)\pi$ is $\mf{w'}$-generic. If $j : S \to G_0$ is the embedding with $\pi=\pi_j$, then $\tx{Ad}(\bar g)\pi_j$ is associated to the embedding $\tx{Ad}(\bar g)\circ j$.

As described in \S\ref{sub:intstr}, the bijection $\pi_0(S_\varphi)^* \to \Pi_\varphi$ is the composition of the orbit map for the action of $\pi_0(S_\varphi)^*=H^1(\R,S)$ on $\mc{J}(\R)/G_0(\C)$ through the embedding $j$ with the $G_0(\C)$-equivariant bijection $\mc{J}(F) \to \tilde\Pi_\varphi$. Neither the latter bijection nor the action of $H^1(\R,S)$ on $\mc{J}(\R)/G_0(\C)$ depend on $\mf{w}$, only the particular point $j \in \mc{J}(F)$ does. The orbit map through $j$ is given by $x \mapsto (x,j)$, while the orbit map through $\tx{Ad}(\bar g)\circ j$ is given by $x \mapsto (x,\tx{Ad}(\bar g)\circ j)$. But $(x,\tx{Ad}(\bar g)\circ j)=g(g^{-1}x\sigma(g),j)g^{-1}$, for any $g \in G_0(\C)$ lifting $\bar g \in G_{0,\tx{ad}}(\R)$.

Now $z(\sigma)=g^{-1}\sigma(g)$ belongs to $Z^1(\R,Z(G_0))$. We conclude that $(x,\tx{Ad}(\bar g),j)$ is equivalent modulo the action of $G_0(\C)$ to $(z\cdot x,j)$. This shows that the bijection $H^1(\R,S) \to \Pi_\varphi$ normalized via $\mf{w'}=\tx{Ad}(g)\mf{w}$ is obtained form the bijection normalized via $\mf{w}$ by shifting the latter via multiplication by $[z] \in H^1(\R,Z(G_0))$. 

Now consider the identification $\pi_0(S_\varphi)^* = H^1(\R,S)$. It can be extended to a commutative diagram
\[ \xymatrix{
	\pi_0(S_\varphi)^*\ar[r]^\cong&H^1(\R,S)\\
	H^1(W_\R,\hat G_\tx{sc} \to \hat G)^*\ar[u]\ar[r]^\cong&H^1(\R,Z(G_0)).\ar[u]
}
\]
We have used here the $W_\R$-cohomology of the crossed module $\hat G_\tx{sc} \to \hat G$ and the duality between it and the $\Gamma$-cohomology of the crossed module $G \to G_\tx{ad}$. The latter is however quasi-isomorphic to $Z(G_0)$. The left vertical map is obtained from the long exact cohomology sequence for the crossed module $\hat G_\tx{sc} \to \hat G$ endowed with $W_\R$-action given by $\tx{Ad}\circ\varphi$. The edge map $S_\varphi=H^0(W_\R,\varphi,\hat G) \to H^1(W_\R,\hat G_\tx{sc} \to \hat G)$ factors through $\pi_0(S_\varphi)$. Note that, the cohomology of $\hat G_\tx{sc} \to \hat G$ is canonically the same whether we take the $W_\R$-action coming from the dual groups, or the one coming from $\tx{Ad}\circ\varphi$, because the two structures differ by a homotopically trivial twist in the sense of \cite[\S2.4]{KalECI}. For an alternative construction without resorting to crossed modules we refer to \cite[\S4]{KalGen}.

If we denote by $(\mf{w},\mf{w'})$ the character of $H^1(W_\R,\hat G_\tx{sc} \to \hat G)$ corresponding to $[z]$, as well as its pull-back to $\pi_0(S_\varphi)$, then we obtain the formula
\begin{equation}
	\iota_\mf{w'}(x) = \iota_\mf{w}(x \cdot (\mf{w},\mf{w'})).
\end{equation}


\subsection{The case of a cover of $G$} \label{sub:packetcover}

\warn{TODO}


\section{Endoscopic character identities}

Let $\varphi : W_\R \to {^LG}$ be a discrete parameter. Let $s \in S_\varphi$ (resp. $s \in S_\varphi^+$) be a semi-simple element. Let $(H,s,\mc{H},\eta)$ be the (pure or rigid) refined endoscopic datum associated to the pair $(\varphi,s)$, whose construction was reviewed in \S\ref{sub:covendo}.

% \subsection{Construction of endoscopic datum}

% \warn{Recall here how to construct} $(H,\mc{H},s,\eta)$.

% We first review the factored parameter using covers. Recall from \S\ref{sub:covendo} that there is a natural double cover $H(\R)_\pm$ of $H(\R)$ and a natural identification $^LH_\pm \to \mc{H}$. According to \warn{ref}, the image of $\varphi$ is contained in the image of $\eta$, hence $\varphi = \eta \circ \varphi_H$ for an $L$-parameter $\varphi_H : W_\R \to {^LH}_\pm$. Note that $\varphi_H$ is automatically discrete.

% We now review the factored parameter in the classical set up. For this, one attempts to choose an $L$-isomorphism $\xi : {^LH} \to \mc{H}$. This is possible when the derived subgroup of $G$ is simply connected (cf. \cite{Lan79}), and in some other cases, but not in general. Therefore, the general strategy is to choose a $z$-extension $H_1 \to H$ and an $L$-embedding $^L\eta : \mc{H} \to {^LH_1}$ which extends the tautological embedding $\hat H \to \hat H_1$. The composition of $\varphi_H : W_\R \to \mc{H}$ with $^L\eta$ is then an $L$-parameter $\varphi_{H_1} : W_\R \to {^LH_1}$, again automatically discrete.



% \subsection{Review of transfer factors and the transfer theorem} \label{sub:trans}

% \warn{TODO}

% The reader can skim this and come back to it later.

\subsection{Statement of the main theorem}

As discussed in \S\ref{sub:packetcover} there is an associated compound $L$-packet $\Pi_{\varphi_H}$. We will be only interested in the contribution of the trivial twist $(H,1,1)$, and we write $\Pi_\varphi(H) \subset \Pi_{\varphi_H}$ for it. Consider the virtual character
\[ S\Theta_{\varphi_H} := \sum_{\sigma \in \Pi_\varphi(H)} \<\sigma,s\>\Theta_\sigma = \sum_{\sigma \in \Pi_\varphi(H)} \<\sigma,1\>\Theta_\sigma = \sum_{\sigma \in \Pi_\varphi(H)} \Theta_\sigma\]
on $H(\R)_\pm$, where $\<\sigma,-\>$ is the character of the irreducible representation of $\pi_0(S_\varphi)$ (resp. $\pi_0(S_\varphi^+)$) associated to $\sigma$ by the bijection of \S\ref{sub:intstr}. Let us argue the two equalities. Since $Z(\hat H)^\Gamma$ (resp. $Z(\hat{\bar H})^+$) acts trivially on this irreducible representation, and $s$ belongs by construction to this group, we see $\<\sigma,s\>=\<\sigma,1\>$, hence the first equality. The second comes from the fact that $S_\varphi$ is abelian, because it lies in $\hat S$ (and $S_\varphi^+$ lies in $\hat{\bar S}$), where $\hat S$ is the torus involved in the construction of the $L$-packet on $H$. Note that, while the bijection of \S\ref{sub:intstr} depends on the choice of a Whittaker datum, the argument of \S\ref{sub:whit} shows that the value $\<\sigma,1\>$ does not depend on this choice.

Let $(G,\xi,z)$ be a pure (resp. rigid) inner twist of $G_0$. We have the virtual character on $G(\R)$ given by
\[ \Theta_{\varphi}^{\mf{w},s} := e(G)\sum_{\pi \in \Pi_\varphi((G,\xi,z))} \<\pi,s\>\Theta_\pi. \]
This virtual character does depend on $\mf{w}$.

The following is the main theorem of this article. It is a fundamental result of Shelstad \cite{She82}, \cite{SheTE2}, \cite{SheTE3}.
\begin{thm} \label{thm:main1}
Let $f \in \mc{C}^\infty_c(G(\R))$ be a test function.
\begin{enumerate}
	\item If $f^{H_\pm} \in \mc{C}^\infty_c(H(\R)_\pm)$ matches $f$ as in Definition \ref{dfn:matching}, then
	\[ \Theta_\varphi^{\mf{w},s}(f) = S\Theta_{\varphi_H}(f^{H_\pm}). \]
	\item If $f^{H_1} \in \mc{C}^\infty_c(H_1(\R))$ matches $f$ as in Definition \ref{dfn:matching}, then
	\[ \Theta_\varphi^{\mf{w},s}(f) = S\Theta_{\varphi_{H_1}}(f^{H_1}). \]
\end{enumerate}
\end{thm}


\subsection{Reduction to the elliptic set}

\begin{thm} \label{thm:main2}
\begin{enumerate}
	\item For every strongly regular semi-simple element $\delta \in G(\R)$ the following identity holds
	\[ \Theta_\varphi^{\mf{w},s}(\delta) = \sum_{\gamma \in H(\R)/\tx{st}} \Delta[\mf{w},\mf{e},z](\dot\gamma,\delta)S\Theta_{\varphi_H}(\dot\gamma). \]
	\item For every strongly regular semi-simple element $\delta \in G(\R)$ the following identity holds
	\[ \Theta_\varphi^{\mf{w},s}(\delta) = \sum_{\gamma \in H(\R)/\tx{st}} \Delta[\mf{w},\mf{e},\mf{z},z](\gamma_1,\delta)S\Theta_{\varphi_{H_1}}(\gamma_1). \]
\end{enumerate}
\end{thm}


\begin{lem}
Theorem \ref{thm:main1} is equivalent to Theorem \ref{thm:main2}.
\end{lem}
\begin{proof}
\warn{TODO}
\end{proof}

\begin{lem}
If Theorem \ref{thm:main2} holds for all elliptic $\delta$, then it holds for all $\delta$.
\end{lem}
\begin{proof}
\warn{TODO}
\end{proof}

\subsection{The left hand side}

% Let $\pi_\mf{w} \in \Pi_\varphi(G_0)$ be the unique $\mf{w}$-generic constituent. It corresponds to a triple $(S,\rho,\tau)$, where $S \subset G_0$ is an elliptic maximal torus, $\rho$ is a Weyl chamber in $X^*(S/Z_G)$, and $\tau$ is a character of $S(\R)$ whose differential is $\rho$-dominant. This triple is unique up to $G(\R)$-conjugacy.

% Fix based $\chi$-data for $(S,\rho)$ and consider the resulting $\hat G$-conjugacy class of embeddings ${^LS} \to {^LG}$. There exists a member of this class whose image contains the image of $\varphi$, and such that the factored parameter $\varphi_S : W_\R \to {^LS}$ gives rise to the character $\tau$. This embedding is well-defined up to conjugation by $\hat S$. It gives an isomorphism $\hat S^\Gamma \to S_\varphi$ that is independent of all choices (it depends on the choice of $\varphi$ within its $\hat G$-conjugacy class, but so does $S_\varphi$, and the whole situation is independent of this choice in the obvious way).

In this subsection we will provide a formula for the left hand side of the identity in Theorem \ref{thm:main2}, i.e. $\Theta^\mf{w}_{\varphi,s}(\delta)$, for strongly regular semi-simple elliptic $\delta \in G(\R)$. The end result is \eqref{eq:lhs}.

The members of $\Pi_\varphi((G,\xi,z))$ are parameterized by the set of $G(\R)$-conjugacy classes of admissible embedding $j : S \to G$. Given such an embedding let $\pi_j$ be the corresponding representation. Let $j_\mf{w} : S \to G_0$ be the unique embedding for which $\pi_{j_\mf{w}}$ is the unique $\mf{w}$-generic member of $\Pi_\varphi((G_0,1,1))$. Then $\tx{inv}(j_\mf{w},j) \in H^1(\Gamma,S)=\pi_0(\hat S^\Gamma)^*=\pi_0(S_\varphi)^*$ equals $\rho_{\pi_j}$. Therefore the left hand side becomes
\[ \Theta^\mf{w}_{\varphi,s}(\delta)=e(G)\sum_j \<s,\tx{inv}(j_\mf{w},j)\>\Theta_{\pi_j}(\delta), \]
where $j$ runs over (a set of representatives for) the set of $G(\R)$-conjugacy classes in $J_\xi$. Harish-Chandra's character formula \eqref{eq:charfmla} states
\[ \Theta_{\pi_j}(\delta) = (-1)^{q(G)}\sum_{w \in W_\R(G,jS)}\frac{\tau'}{d_\tau'}(j^{-1}w^{-1}\delta),\]
where we have conjugated $\delta$ within $G(\R)$ to land in $jS(\R)$. Combining the two formulas and using $e(G)=(-1)^{q(G_0)-q(G)}$, we obtain
\[ \Theta^\mf{w}_{\varphi,s}(\delta) = (-1)^{q(G_0)} \sum_j \<s,\tx{inv}(j_\mf{w},j)\> \sum_{w \in W_\R(G,jS)}\frac{\tau'}{d_\tau'}(j^{-1}w^{-1}\delta). \]

% The product in the denominator can be rewritten as
% \[ \prod\limits_{\substack{\alpha \in R(S,G)\\ \<\alpha,d\tau\>>0}}(1- \alpha(j^{-1}w^{-1}\delta)^{-1}). \]
Instead of conjugating $\delta$ to land in $jS$, we can conjugate $j$ by $G(\R)$ to achieve this, without changing $\pi_j$. With this shift in point of view we can combine the two sums and arrive at
\[ \Theta^\mf{w}_{\varphi,s}(\delta) = (-1)^{q(G_0)} \sum_j \<s,\tx{inv}(j_\mf{w},j)\> \frac{\tau'}{d_\tau'}(j^{-1}w^{-1}\delta), \]
where now the sum runs over the set of those $j \in J_\xi$ whose image contains $\delta$.

As $j$ runs over this set, $j_\mf{w}j^{-1}(\delta)$ runs over the set of elements $\delta_0 \in S_\mf{w}(\R)$ that are stably conjugate to $\delta$, where $S_\mf{w} \subset G_0$ is the image of $j_\mf{w}$, an elliptic maximal torus of $G_0$. Moreover, $j_\mf{w}$ transports $\tx{inv}(j_\mf{w},j) \in H^1(\R,S)$ to $\tx{inv}(\delta_0,\delta) \in H^1(\R,S_\mf{w})$. So we arrive at
\begin{equation} \label{eq:lhs}
\Theta^\mf{w}_{\varphi,s}(\delta) = (-1)^{q(G_0)} \sum_{\delta_0} \<s_\mf{w},\tx{inv}(\delta_0,\delta)\> \frac{\tau_\mf{w}'}{d_{\mf{w}}'}(\delta_0),
\end{equation}
where the sum runs over the set of elements $\delta_0 \in S_\mf{w}(\R)$ that are stably conjugate to $\delta$, and we have used the subscript $\mf{w}$ to indicate various transports under $j_\mf{w} : S \to S_\mf{w}$.


\subsection{The right hand side: covers} \label{sub:rhs_cover}

In this subsection we will show that the right hand side of the identity of Theorem \ref{thm:main2}(1) is also equal to \eqref{eq:lhs}.

We begin by applying \eqref{eq:lhs} to the group $H$, the parameter $\varphi_H$, and the trivial endoscopic element, and obtain
\[ S\Theta_{\varphi_H}(\dot\gamma) = \sum_{\dot\gamma_0} \frac{\tau_H}{d_{H}}(\dot\gamma_0), \]
where we have fixed an embedding $j_H : S \to H$ for which the corresponding discrete series representation of $H(\R)_\pm$ is generic with respect to some Whittaker datum and denote by subscript $H$ the various transports under $j_H$, $\dot\gamma_0$ runs over the elements of $S_H(\R)_\pm$ that are $H$-stably conjugate to $\dot\gamma$, and we have used $\tau_H/d_H=\tau'_H/d'_H$.

The right hand side of Theorem \ref{thm:main2}(1) then becomes
\[ \sum_{\gamma \in H(\R)/\tx{st}} \Delta[\mf{w},\mf{e},z](\dot\gamma,\delta)\sum_{\dot\gamma_0} \frac{\tau_H}{d_{H}}(\dot\gamma_0). \]
The first sum runs over elements of $H(\R)$ that are related to $\delta$, up to stable conjugacy under $H$. Each such stable conjugacy class consists of regular semi-simple elliptic elements (because $\delta$ is such), and hence intersects $S_H(\R)$. The second sum runs over elements $\dot\gamma_0 \in S_H(\R)_\pm$ that lie in the $H$-stable class of the lift $\dot\gamma \in S_H(\R)_\pm$ of $\gamma$. Since $\Delta$ is $H$-stably invariant in the first factor, its values at $\dot\gamma$ and $\dot\gamma_0$ are the same. We can combine the two sums together and obtain
\[ \sum_{\gamma_0 \in S_H(\R)} \Delta[\mf{w},\mf{e},z](\dot\gamma_0,\delta) \frac{\tau_H}{d_{H}}(\dot\gamma_0), \]
where now $\gamma_0$ runs over all elements of $S_H(\R)$, equivalently all those that are related to $\delta$, since the transfer factor vanishes for the others.


Having fixed the embeddings $j_\mf{w}$ and $j_H$, they provide an isomorphism $S_\mf{w} \to S_H$, and this isomorphism induces a bijection
\[ \delta_0 \leftrightarrow \gamma_0 \]
between the set of elements of $S_\mf{w}(\R)$ that are stably conjugate to $\delta$ and the set of elements of $S_H(\R)$ related to $\delta$. Using the basic property \eqref{eq:tfstab} of transfer factors we obtain
\begin{equation} \label{eq:rhs1}
\sum_{\delta_0 \in S_\mf{w}(\R)} \Delta[\mf{w},\mf{e},z](\dot\gamma_0,\delta_0)\<s_\mf{w},\tx{inv}(\delta_0,\delta)\> \frac{\tau_H}{d_{H}}(\dot\gamma_0),
\end{equation}
where $\delta_0$ runs over the elements of $S_\mf{w}(\R)$ that are stably conjugate to $\delta$, $\gamma_0 \in S_H(\R)$ denotes the element corresponding to $\delta_0$ under above bijection, and $\dot\gamma_0 \in S_H(\R)_\pm$ is an arbitrary lift of $\gamma_0$.

We now unpack the transfer factor. It is given as
\[ \Delta(\dot\gamma_0,\delta_0) = \epsilon\Delta_I^{-1}(\dot\gamma_0,\dot\delta_0)\Delta_{III}(\dot\gamma_0,\dot\delta_0), \]
where we recall that the term $\Delta_{IV}$ is missing because we are working with normalized characters and orbital integrals, and $\dot\delta_0 \in S_\mf{w}(\R)_{G/H}$ is an arbitrary lift of $\delta_0$.
%Here $\dot\delta_0 \in S_\mf{w}(\R)_\pm$ is the image of $\dot\gamma_0$ under the isomorphism $S_\mf{w}(\R)_\pm \to S_H(\R)_\pm$, and $\ddot\delta_0$ is a lift of this element to $S_\mf{w}(R)_\pm \times_{S_\mf{w}(\R)} S_\mf{w}(\R)_{G/H}$.

We claim that
\[ \Delta_{III}(\dot\gamma_0,\dot\delta_0) = \frac{\tau_\mf{w}}{\tau_H}(\dot\delta_0). \]
To see this, we note that we have the commutative diagram
\[ \xymatrix{
	&^LS_{H,\pm}\ar[dd]_a\ar[r]&^LH_\pm\ar[dd]\\
	W_\R\ar[ru]^{\varphi^H_S}\ar@/^4pc/[rru]_-{\varphi^H}\ar[rd]_{\varphi_S}\ar@/_4pc/[rrd]_-{\varphi}\\
	&^LS_G\ar[r]&^LG,
}
\]
Here $^LS_G$ is the $L$-group of the double cover $S(\R)_G$ and the bottom horizontal map is the canonical $L$-embedding. We have written $^LS_{H,\pm}$ for the $L$-group of the double cover of $S_H(\R)$ obtained as the Baer sum of the canonical double cover $S_H(\R)_H$ coming from $R(S_H,H) \subset X^*(S_H)$ and the double cover $S_H(\R)_\pm$ that is the preimage of $S_H(\R)$ in the double cover $H(\R)_\pm \to H(\R)$. The top horizontal map is the canonical $L$-embedding of the $L$-group of $S_H(\R)_H$ into $^LH$, which remains an $L$-embedding after passing to the $\pm$-covers. The right vertical map is the canonical $L$-embedding $^LH_\pm \to {^LG}$. The map $a$ is the unique map making the square, hence also the triangle, commute. It is the paremter of a genuine character of the double cover of $S(\R)$ obtained as the Baer sum of $S_H(\R)_H$, $S_H(\R)_\pm$, and $S(\R)_G$, where we have identified $S_H$ with $S$. This Baer sum is the same as for $S_H(\R)_\pm$ and $S(\R)_{G/H}$. The claimed identity now follows.

The following lemma completes the proof of Theorem \ref{thm:main2}(1).


\begin{lem} \label{lem:magic}
For any $\dot\delta_0 \in S_\mf{w}(\R)_{G/H}$, the following identity holds
\[  \Delta_{I}(\dot\gamma_0,\dot\delta_0) = \epsilon\cdot(-1)^{q(G_0)-q(H)}\cdot\prod_{\alpha \in R(S,G/H)^+}\arg(\alpha^{1/2}(\dot\delta_0) - \alpha^{-1/2}(\dot\delta_0)), \]
where $\dot\gamma_0 \in S_H(\R)_{G/H}$ is the image of $\dot\delta_0$ under the isomorphism $j_H \circ j_\mf{w}^{-1}$.
\end{lem}
\begin{proof}
We first investigate how both sides vary as functions of $\dot\delta_0$. Consider another strongly regular $\dot\delta_1$. Replacing $\dot\delta_0$ with $\dot\delta_1$ in the right hand side results in multiplication by $\prod_\alpha \tx{arg}(b_\alpha)$, where the product runs again over $R(S,G/H)^+$ and $b_\alpha=(\dot\delta_{1,\alpha}-\dot\delta_{1,-\alpha})/(\dot\delta_{0,\alpha}-\dot\delta_{0,-\alpha})$. By construction $\dot\delta_{0,-\alpha}=\sigma(\dot\delta_{0,\alpha})$, and the same holds for $\dot\delta_1$, from which follows $b_\alpha \in \R^\times$, and hence $\tx{arg}(b_\alpha)=\tx{sgn}(b_\alpha)$.

We now look at the left hand side. Replacing $\dot\delta_0$ by $\dot\delta_1$ multiplies $\tx{inv}(\dot\delta_0,\tx{pin})$ by $\prod_{\alpha>0,\sigma\alpha<0}\alpha^\vee(b_\alpha)$, and hence $\Delta_{I}$ by the Tate-Nakayama pairing of this 1-cocycle with the endoscopic element $s_\mf{w}$. Since the torus $S$ is elliptic, the conditions $\alpha>0$ and $\sigma\alpha<0$ are equivalent, and the value of the 1-cocycle at $\sigma$ equals $\prod_{\alpha>0}\alpha^\vee(b_\alpha)$. This is the product over $\alpha>0$ of the images of the 1-cocycles $b_\alpha \in Z^1(\Gamma,R_{\C/R}^1\mb{G}_m)$ under the homomorphisms $\alpha^\vee : R_{\C/R}^1\mb{G}_m \to S$, so the change in $\Delta_{I,\pm}$ is given by $\prod_{\alpha>0}\<b_\alpha,s_\alpha\>$, where $s_\alpha$ is the image of $s \in \hat S$ under $\hat\alpha : \hat S \to \C^\times$. This is a Galois-equivariant homomorphism, with $\sigma$ acting as inversion on $\C^\times$. Since $s$ is $\sigma$-fixed, so is $s_\alpha$, i.e. $s_\alpha \in \{\pm1\} \subset \C^\times$. By construction of the endoscopic group $H$, we have $s_\alpha=1$ precisely for $\alpha \in R(S,H)$. On the other hand, when $s_\alpha=-1$, then $\<b_\alpha,s_\alpha\>=\tx{sgn}(b_\alpha)$.

We have thus shown that both sides of the identity multiply by the same factor upon replacing $\dot\delta_0$ by a different element $\dot\delta_1$. To establish the identity we may thus evaluate at an arbitrary element $\dot\delta_0$. For this we note that both sides descend to functions on $S_\tx{ad}(\R)_{G/H}$, so we may assume that $G$ is adjoint. Let $\rho^\vee \in X_*(S_\mf{w})$ denote half the sum of the coroots that pair positively with $d\tau_\mf{w}$. Since complex conjugation acts on $X_*(S_\mf{w})$ by multiplication by $-1$, we have $X=\rho^\vee(-ir) \in \tx{Lie}(S_\mf{w})(\R)$ for any $r \in \R$. We will choose $r>0$ small enough and set $\ddot\delta=\exp(X) \in S_\mf{w}(\R)_{\pm\pm}$, where we are using the exponential map $\tx{Lie}(S_\mf{w})(\R) \to S_\mf{w}(\R)_{\pm\pm}$ discussed in \cite[\S3.7]{KalDC}.



Considering the right hand side, we have for each $\alpha \in R(S,G)$
\[ \alpha^{1/2}(\dot\delta_0)=\dot\delta_{0,\alpha} = \exp(d\alpha(X)/2)=e^{-ir\<d\alpha,\rho^\vee\>/2}.\]
Then
\[ \alpha^{1/2}(\dot\delta_0)-\alpha^{-1/2}(\dot\delta_0) = -2i\sin(r\<d\alpha,\rho^\vee\>/2). \]
Choosing $r>0$ so that $r\<d\alpha,\rho^\vee\>/2 < \pi$ for all $\alpha \in R(S,G)^+$ we obtain
\[ \arg(\alpha^{1/2}(\dot\delta_0) - \alpha^{-1/2}(\dot\delta_0)) = (-i)^{\#R(S,G/H)^+}. \]
Choose a pinning $(T_0,B_0,\{X_\alpha\})$, which, together with $\Lambda(x)=e^{2\pi ix}$, produces the chosen Whittaker datum $\mf{w}$. Corollary \ref{cor:gen} then shows that $\rho^\vee(-i)$ is $G_0(\R)$-conjugate lies in the Kostant section of that pinning. Thus $X$ is $G_0(\R)$-conjugate to the Kostant section of the pinning $(T_0,B_0,\{rX_\alpha\})$. If we construct $\Delta_I(\dot\gamma_0,\dot\delta_0)$ with respect to this rescaled pinning, then \cite[Lemma 4.1.4]{KalHDC} show that $\Delta_I(\dot\gamma_0,\dot\delta_0)=1$. On the other hand, the rescaled pinning together with the character $\Lambda_r(x)=e^{r2\pi i x}$ also produces the Whittaker datum $\mf{w}$. According to Lemma \ref{lem:epsilon} the right hand side equals $1$.
\end{proof}

\subsection{The right hand side: classical set-up}

In this subsection we will show that the right hand side of the identity of Theorem \ref{thm:main2}(2) is also equal to \eqref{eq:lhs}. The initial arguments of \S\ref{sub:rhs_cover}, which applied to the right hand side of the identity in Theorem \ref{thm:main2}(1), have direct analogs in the setting of Therem \ref{thm:main2}(2) and show that the right hand side of that identity equals the analog of the expression \eqref{eq:rhs1}, which is given by
\begin{equation} \label{eq:rhs2}
\sum_{\delta_0 \in S_\mf{w}(\R)} \Delta[\mf{w},\mf{e},z](\gamma_1,\delta_0)\<s_\mf{w},\tx{inv}(\delta_0,\delta)\> \frac{\tau'_{H_1}}{d'_{H_1}}(\gamma_1),	
\end{equation}
where we have used the parameter $\varphi_{H_1}$ of the z-extension $H_1$ to obtain the character $\tau_{H_1}'$ of the torus $S_{H_1}(\R)$.


It is the handling of the transfer factor that is slightly different. Indeed, in this setting without covers the transfer factor is given by
\[ \Delta = \epsilon\Delta_I^{-1}\Delta_{II}\Delta_{III_2}. \]
The construction of the pieces involves a choice of an admissible isomorphism $S^H \to S_\mf{w}$, which we take to be $j_\mf{w}\circ j_H^{-1}$, as we did in \S\ref{sub:rhs_cover}. It further involves choices of $\chi$-data and $a$-data for $S$. We take $\rho$-based $\chi$-data, and $(-\rho)$-based $a$-data, so that $\chi_\alpha(x)=\arg(x)$ when $\alpha>0$ and $a_\alpha=i$ when $\alpha<0$.

We claim that
\[ \Delta_{III_2}(\gamma_1,\delta_0) = \frac{\tau'_\mf{w}(\delta_0)}{\tau'_{H_1}(\gamma_1)}.\]
We will explain this under the assumption that the $z$-pair is trivial, i.e. there exists an $L$-isomorphism $^L\eta : {^LH} \to \mc{H}$, the general case being entirely analogous by requiring more cumbersome notation. We then have the commutative diagram
\[ \xymatrix{
	&^LS_H\ar[dd]_a\ar[r]^{\rho^H}&^LH\ar[dd]^{^L\eta}\\
	W_\R\ar[ru]^{\varphi^H_S}\ar@/^4pc/[rru]_-{\varphi^H}\ar[rd]_{\varphi_S}\ar@/_4pc/[rrd]_-{\varphi}\\
	&^LS\ar[r]^{\rho}&^LG,
}
\]
where the horizontal arrows are the $L$-embeddings obtained via $\rho$-based and $\rho^H$-based $\chi$-data, respectively. We have $\Delta_{III_2}(\gamma_1,\delta_0)=\<a,\delta_0\>$, where $a \in Z^1(W_\R,\hat S)$ is the $1$-cocycle that makes the above diagram commute, the pairing is the Langlands pairing, and $\delta_0 \in S(\R)$ is the image of $\gamma_0 \in S^H(\R)$ to $S(\R)$ under the chosen fixed admissible isomorphism. The claim now follows from the above commutative diagram and the fact that $\tau$ and $\tau^H$ are the characters with parameters $\varphi_S$ and $\varphi_S^H$.



Next we consider
\[ \frac{\Delta_{II}(\gamma_0,\delta)}{d'_H(\gamma_0)}.\]
By definition,
\[ \Delta_{II}(\gamma_0,\delta) = \frac{\Delta_{II}^G(\gamma_0,\delta)}{\Delta_{II}^H(\gamma_0,\delta)}.\]
With the chosen $a$-data and $\chi$-data we have
\[ \Delta_{II}^H(\gamma_0)=\prod\limits_{\substack{\alpha \in R(S^H,H)\\ \<\alpha,\rho^H\>>0}}\tx{arg}\Big(\frac{\alpha(\gamma_0)-1}{-i}\Big) = i^{\#R(S^H,H)/2}\cdot\prod\limits_{\substack{\alpha \in R(S^H,H)\\ \<\alpha,\rho^H\>>0}}\tx{arg}(\alpha(\gamma_0)-1). \]
On the other hand,
\[ (\alpha(\gamma_0)-1)(1-\alpha(\gamma_0)^{-1})=\alpha(\gamma_0)+\alpha(\gamma_0)^{-1}-2=2(\tx{Re}(\alpha(\gamma_0)-1) < 0.\]
Hence
\[ \Delta_{II}^H(\gamma_0,\delta)d_H'(\gamma_0) = (-i)^{\#R(S^H,H)/2}. \]
In the same way one shows
\[ \Delta_{II}^G(\gamma_0,\delta)d_{G_0}'(\delta_0)) = (-i)^{\#R(S,G_0)/2}. \]
and we conclude
\[ \frac{\Delta_{II}(\gamma_0,\delta)}{d_H'(\gamma_0)} = \frac{i^{\#R(S^H,H)/2-\#R(S,G_0)/2}}{d_{G_0}'(\delta_0)}.\]
With this \eqref{eq:rhs2} becomes
\[ (-1)^{q(H)}i^{\#R(S^H,H)/2-\#R(S,G_0)/2}\epsilon \sum_{\delta_0 \in S_\mf{w}(\R)}\Delta_I(\gamma_0,\delta)^{-1} \<s_\mf{w},\tx{inv}(\delta_0,\delta)\> \cdot\frac{\tau_\mf{w}(\delta_0)}{d'_{G_0}(\delta_0)}. \]
We have
\[ \Delta_{I}(\gamma_0,\delta)^{-1} = \<s,\lambda\>^{-1} \]
where $\lambda \in H^1(\Gamma,S)$ is the splitting invariant of $S$ relative to the chosen $a$-data. Using Lemma \ref{lem:epsilon} we obtain
\[(-1)^{q(G_0)}\<s,\lambda\>^{-1}\sum_{\delta_0}\<s,\tx{inv}(\delta_0,\delta)\>\cdot\frac{\tau_\mf{w}(\delta_0)}{d_{G_0}'(\delta_0)}. \]

The following lemma completes the proof.

\begin{lem} \label{lem:gen}
The splitting invariant $\lambda$ of $S$ computed in terms of $(-\rho)$-based $a$-data is trivial.
\end{lem}
\begin{proof}
Let $X=\rho^\vee(-i) \in \tx{Lie}(S_\tx{sc})$. This element is Galois-fixed and thus lies in $\tx{Lie}(S_\tx{sc})(\R)$. For every $\alpha>0$ the complex number $d\alpha(X)$ is a positive real multiple of $-i$. Therefore we can replace the $(-\rho)$-based $a$-data with the $a$-data $d\alpha(X)$ without changing the splitting invariant. According to \cite[Theorem 5.1]{Kot99} and Corollary \ref{cor:gen}, $\lambda$ is trivial.
\end{proof}




\bibliographystyle{amsalpha}
%\bibliography{/Users/kaletha/Work/TexMain/bibliography.bib}
\bibliography{bibliography}

\end{document}



Each $H$-stable conjugacy class of elliptic strongly regular semi-simple elements intersects $S_H(\R)$ in a $\Omega(S_H,H)(\R)$-orbit. The sum over $\gamma_0$ is then precisely over that orbit. On the other hand, the set of


Via the embeddings $j_\mf{w}$ and $j_H$ we have the subsets $R(S,H) \subset R(S,G) \subset X^*(S)$ and the subgroups $\Omega(S,H) \subset \Omega(S,G) \subset \tx{Aut}(S)$.

Fix elliptic maximal tori $S' \subset G$ and $T \subset H$. The set of admissible isomorphisms $S' \to T$ is a torsor under $\Omega(S',G')(\R)$. Two strongly regular elements of $S'(\R)$ are stably conjugate in $G'(\R)$ if and only if they are in the same orbit under $\Omega(S',G')(\R)$. Two strongly regular elements of $T(\R)$ are stably conjugate in $H(\R)$ if and only if they are in the same orbit under $\Omega(T,H)(\R)$. Any admissible isomorphism $S' \to T$ transports $\Omega(S',G)$ to a subgroup of $\tx{Aut}(T)$ that contains $\Omega(T,H)$. The subgroup of $\tx{Aut}(T)$ obtained this way is independent of the admissible isomorphism chosen to transport it.


Fix $\delta \in S'(\R)$ strongly regular and consider the right hand side in Theorem \ref{thm:main2}. The restriction of $S\Theta_\varphi$ to $T(\R)_\pm$ is given by
\[ \gamma \mapsto \sum_{w \in \Omega(T,H)(\R)} \frac{\theta_H(w^{-1}\dot \gamma)}{\prod_{\alpha \in R(T,H)^+}(\alpha^{1/2}(w^{-1}\dot \gamma)-\alpha^{-1/2}(w^{-1}\dot \gamma))}. \]
An element $\gamma \in H(\R)_\pm$ which is related to $\delta$ is $H(\R)$-conjugate to an element of $T(\R)_\pm$. Two elements of $T(\R)_\pm$ that are related to $\delta$ are conjugate under $\Omega(S',G)(\R)$. We fix one $\gamma_0 \in T(\R)_H$ related to $\delta$. With this, the right hand side becomes
\[ \sum_{u \in \Omega(S',G)(\R)/\Omega(T,H)(\R)} \Delta(u^{-1}\gamma_0,\delta)\sum_{w \in \Omega(T,H)(\R)} \frac{\theta_H(w^{-1}u^{-1}\dot \gamma_0)}{\prod_{\alpha \in R(T,H)^+}(\alpha^{1/2}(w^{-1}u^{-1}\dot \gamma_0)-\alpha^{-1/2}(w^{-1}u^{-1}\dot \gamma_0))}.\]
The transfer factor is invariant under stable conjugacy in the first variable, so we may replace $u^{-1}\gamma_0$ by $w^{-1}u^{-1}\gamma_0$ and combine both sums, leading to
\[ \sum_{u \in \Omega(S',G)(\R)} \Delta(u^{-1}\gamma_0,\delta) \frac{\theta_H(u^{-1}\dot \gamma_0)}{\prod_{\alpha \in R(T,H)^+}(\alpha^{1/2}(u^{-1}\dot \gamma_0)-\alpha^{-1/2}(u^{-1}\dot \gamma_0))}.\]
